<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>成员</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" user-scalable="no">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="css/member.css">

    <!--[if lt IE9]>
    <script src="js/html5.js"></script>
    <script src="js/IE7.js"></script>
    <![endif]-->
</head>

<body>
    <header>
        <nav id="header_menu">
        </nav>
    </header>
    <div class="header-fixed">
        <nav id="header_menu_fixed">
        </nav>
    </div>

    <section class="container">

    </section>
    <div class="mask-details">
        <div class="details"></div>
    </div>
    <script type="text/javascript" src="js/ss.js"></script>
    <script type="text/javascript" src="js/libs/jQuery/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="js/libs/jQuery/QRcode/jquery.qrcode.min.js"></script>
    <script src="js/libs/jQuery/jquery.lazyload.mini.js"></script>
    <script type="text/javascript" src="js/ls.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/static/src/mask-details.js"></script>
    <script type="text/tmpl" id="containerTpl">
        <div class="panel">
            <div class="head">
                <div class="item qr" onclick="loadQr();">加入班级</div>
                <div class="item member" onclick="loadMember();">成员</div>
                <div class="item team" onclick="loadTeam();">小组</div>
                <div style="clear:both;"></div>
            </div>
            <div class="body">
                <div class="item qr">
                    <div class="img" ></div>
                    <br/>
                    <br/>
                    <span style="display:none;">编码:<%= data.qr.code%></span>
                    <br/>
                    <br/>
                    <br/>
                </div>
                <div class="item member">
                    <% for(var i = 0;i < data.member.item.length ; i++){ %>
                        <div class="item" onclick="details('<%=data.member.item[i].id%>')">
                            <img src="<%= data.member.item[i].icon %>?imageView2/1/w/200/h/200" onerror="noFindImg();"/>
                            <br/>
                            <br/>
                            <span><%= data.member.item[i].name %></span>
                        </div>
                    <% } %>
                    <div style="clear:both;"></div>
                </div>
                <div class="item team">
                    <% for(var i = 0;i < data.team.length ; i++){ %>
                        <div class="item">
                            <div class="left"><%= data.team[i].name%></div>
                            <div class="right">
                                <div class="warp">
                                    <% for(var j = 0;j < (data.team[i].saList || []).length ; j++){ %>
                                        <div class="<%= data.team[i].saList[j].isLeader?'item leader':'item' %>" onclick="details('<%=data.team[i].saList[j].studentId%>')">
                                            <img src="<%= data.team[i].saList[j].icon %>?imageView2/1/w/200/h/200" onerror="noFindImg();" />
                                            <br/>
                                            <br/>
                                            <span><%= data.team[i].saList[j].name %></span>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } %>
                    <div style="clear:both;"></div>
                </div>
            </div>
        </div>
    </script>
    <script type="text/javascript">
        var request = GetRequest();
        var showItem = +request['defaultTabItem'] || 0; //当前显示的项目

        var PageData = {
            qr:{
                src:"",
                code:"",
            },
            member:{
                item:[],
            },
            team:[]
        };

        //刷新页面局部
        function reFresh() {
            var $result = $( tmpl($("#containerTpl").html(),{
                data:PageData,
            }));

            //初始化操作
            $result.find(".head > .item").on("click",function(){
                tooglePanel( $(this).index() );
            });
            $(".container").html( $result );

            tooglePanel( showItem );
        };

        //切换显示项
        function tooglePanel( index ){
            showItem =  index;
            var $panel = $(".panel");
            $panel.find(".item").removeClass("active");
            $panel.find(".head > .item:eq("+index+"),.body > .item:eq("+index+")").addClass("active");
        }

        //加载数据
        function loadQr(){
            setTimeout(function(){
                $.get(Constant.WEB_ROOT+"/manager/teacher/gradeClass/detail",{classId:SS.get(Constant.classId)},function( data ){
                    var qrText = Constant.WX_HTTPPREFIX +"qrcode.html?type=join&qrcode=" +data.gradeClass.displayCode;
                    var qrSrc = "";
                    PageData.qr = {
                        src:qrSrc,
                        code:data.gradeClass.displayCode,
                    }
                    reFresh();
                    $(".item.qr .img").qrcode({
                        height:435,
                        width:435,
                        text:qrText,
                    });
                });
            },500);
        };
        loadQr();
        function loadMember(){
            $.get(Constant.WEB_ROOT+"/manager/teacher/student/list",{classId:SS.get(Constant.classId)},function( data ){
                PageData.member.item = data.array;
                reFresh();
            });
        };
        loadMember();
        function loadTeam(){
            $.get(Constant.WEB_ROOT+"/manager/teacher/classgroup/list",{classId:SS.get(Constant.classId)},function( data ){

                var team = ( data.list || []).map(function( item ,index ){

                    item.saList = [];
                    $.get(Constant.WEB_ROOT+"/manager/teacher/classgroup/detail",{groupId:item.id},(function(index){
                        return function( data ){
                            //console.table( data.classGroup.studentAuthorityList );
                            data.classGroup.saList = data.classGroup.studentAuthorityList;
                            data.classGroup.studentAuthorityList = null;
                            PageData.team[index] = data.classGroup;
                            //reFresh();
                        }
                    })(index));
                    return item;
                });
                PageData.team = team;
            });
        }
        loadTeam();
        reFresh();
    </script>

    <script type="text/javascript">
        $("[class^=mask]").on("click",function( event ){
            if( this != event.target){
                return;
            }
            $(this).hide();
        });
        /***图片缓加载*/
        $(document).ready(function() {
            $(".item img").lazyload({
                threshold : 100,
                placeholder : "images/default-user.png",
                effect : "fadeIn"
            });
        });
    </script>
</body>

</html>
