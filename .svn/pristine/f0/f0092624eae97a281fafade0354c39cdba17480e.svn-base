<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>成员</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" user-scalable="no">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="css/member.css">

    <!--[if lt IE9]>
    <script src="js/html5.js"></script>
    <script src="js/IE7.js"></script>
    <![endif]-->
</head>

<body>
    <header>
        <nav id="header_menu">
        </nav>
    </header>
    <div class="header-fixed">
        <nav id="header_menu_fixed">
        </nav>
    </div>
    <div id="dialog">
      <div class="dialog-content">
        <div class="star-box" id="star-box">
            <div class="star star1" data-star=1></div>
            <div class="star star2" data-star=2></div>
            <div class="star star3" data-star=3></div>
            <div class="star star4" data-star=4></div>
            <div class="star star5" data-star=5></div>
        </div>
        <div class="groupName">组1</div>
      <div class="dialog-close"></div>
      </div>
    </div>
    <section class="container">

    </section>
    <div class="mask-details">
        <div class="details"></div>
    </div>
    <script type="text/javascript" src="js/ss.js"></script>
    <script type="text/javascript" src="js/libs/jQuery/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="js/libs/jQuery/QRcode/jquery.qrcode.min.js"></script>
    <script src="js/libs/jQuery/jquery.lazyload.mini.js"></script>
    <script type="text/javascript" src="js/ls.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/static/src/mask-details.js"></script>
    <script type="text/tmpl" id="containerTpl">
        <div class="panel">
            <div class="head">
                <div class="item qr" onclick="loadQr();">加入班级</div>
                <div class="item member" onclick="loadMember();">成员</div>
                <div class="item team" onclick="loadTeam();">小组</div>
                <div style="clear:both;"></div>
            </div>
            <div class="body">
                <div class="item qr">
                    <div class="qr-mask">
                        <div class="icon"></div>
                        <div class="title">微信扫一扫,加入班级</div>
                    </div>
                    <div class="img" ></div>
                    <br/>
                    <br/>
                    <span style="display:none;">编码:<%= data.qr.code%></span>
                    <br/>
                    <br/>
                    <br/>
                </div>
                <div class="item member">
                    <% for(var i = 0;i < data.member.item.length ; i++){ %>
                        <div class="item" onclick="details('<%=data.member.item[i].id%>',3)">
                            <img src="<%= data.member.item[i].icon %>?imageView2/1/w/200/h/200" onerror="noFindImg();"/>
                            <br/>
                            <br/>
                            <span><%= data.member.item[i].name %></span>
                        </div>
                    <% } %>
                    <div style="clear:both;"></div>
                </div>
                <div class="item team">
                    <% for(var i = 0;i < data.team.length ; i++){ %>
                        <div class="item" data-id="<%=data.team[i].id%>">
                            <div class="left" ><%= data.team[i].name%></div>
                            <div class="right">
                                <div class="warp">
                                    <% for(var j = 0;j < (data.team[i].saList || []).length ; j++){ %>
                                        <div class="<%= data.team[i].saList[j].isLeader?'item leader':'item' %>" data-id="<%=data.team[i].saList[j].id%>">
                                            <img src="<%= data.team[i].saList[j].icon %>?imageView2/1/w/200/h/200" onerror="noFindImg();" />
                                            <br/>
                                            <br/>
                                            <span><%= data.team[i].saList[j].name %></span>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } %>
                    <div style="clear:both;"></div>
                </div>
            </div>
        </div>
    </script>
    <script type="text/javascript">
        var request = GetRequest();
        var showItem = +request['defaultTabItem'] || 0; //当前显示的项目

        var PageData = {
            qr:{
                src:"",
                code:"",
            },
            member:{
                item:[],
            },
            team:[]
        };

        //刷新页面局部
        function reFresh() {
            var $result = $( tmpl($("#containerTpl").html(),{
                data:PageData,
            }));

            //初始化操作
            $result.find(".head > .item").on("click",function(){
                tooglePanel( $(this).index() );
            });
            $(".container").html( $result );

            tooglePanel( showItem );
        };

        //切换显示项
        function tooglePanel( index ){
            showItem =  index;
            var $panel = $(".panel");
            $panel.find(".item").removeClass("active");
            $panel.find(".head > .item:eq("+index+"),.body > .item:eq("+index+")").addClass("active");
        }

        //加载数据
        function loadQr(){
            setTimeout(function(){
                $.get(Constant.WEB_ROOT+"/manager/teacher/gradeClass/detail",{classId:SS.get(Constant.classId)},function( data ){
                    var qrText = Constant.WX_HTTPPREFIX +"qrcode.html?type=join&qrcode=" +data.gradeClass.displayCode;
                    var qrSrc = "";
                    PageData.qr = {
                        src:qrSrc,
                        code:data.gradeClass.displayCode,
                    }
                    reFresh();
                    $(".item.qr .img").qrcode({
                        height:435,
                        width:435,
                        text:qrText,
                    });
                });
            },500);
        };
        loadQr();
        function loadMember(){
            $.get(Constant.WEB_ROOT+"/manager/teacher/student/list",{classId:SS.get(Constant.classId)},function( data ){
                PageData.member.item = data.array;
                reFresh();
            });
        };
        loadMember();
        function loadTeam(){
            $.get(Constant.WEB_ROOT+"/manager/teacher/classgroup/list",{classId:SS.get(Constant.classId)},function( data ){

                var team = ( data.list || []).map(function( item ,index ){

                    item.saList = [];
                    $.get(Constant.WEB_ROOT+"/manager/teacher/classgroup/detail",{groupId:item.id},(function(index){
                        return function( data ){
                            //console.table( data.classGroup.studentAuthorityList );
                            data.classGroup.saList = data.classGroup.studentAuthorityList;
                            data.classGroup.studentAuthorityList = null;
                            PageData.team[index] = data.classGroup;
                            //reFresh();
                        }
                    })(index));
                    return item;
                });
                PageData.team = team;
            });
        }
        loadTeam();
        reFresh();
    </script>

    <script type="text/javascript">
        var stu_st = [];
        $("[class^=mask]").on("click",function( event ){
            if( this != event.target){
                return;
            }
            $(this).hide();
        });
        /***图片缓加载*/
        $(document).ready(function() {
            $(".item img").lazyload({
                threshold : 100,
                placeholder : "images/default-user.png",
                effect : "fadeIn"
            });
        });
    </script>
    <script type="text/javascript">
      var $dialong = $('#dialog');
      var $starBox = $('#star-box');
      $starBox.on('mouseover', '.star', function(e) {
          // $(e.target).addClass('active')
          var index = $(this).index() + 1;
          $starBox.find(".star:lt(" + index + ")").addClass("active");
      })
      $starBox.on('mouseout', '.star', function(e) {
          $starBox.find('.star').removeClass('active')
      })

      $('#star-box').on('click', '.star', function(e) {
          var $this = $($('#dialog').data("item"));
          var studentIds = [];
          $this.find('.item').each(function(){
            studentIds.push($(this).data('id'));
          });
          console.log();
          var $index = $(this).index() + 1;
          var data = {
              scoreType: 6,
              starNum: $index,
              studentIds: studentIds.join(','),
              targetId:$this.data('id'),
              ttSerialId: SS.get(Constant.timeTableSerialId)
          }
          $.ajax({
              type: "post",
              url: Constant.WEB_ROOT + "/manager/teacher/score/group",
              data: data,
              success: function(data, xhr) {
                  if (xhr === 'success') {
                      if (data.status == 0) {
                          $.alert({
                              title: "系统提示",
                              contentText: '评分成功，本次给出的评分为：' + $index + '星',
                              cancleText: "确定",
                              callback: function(event) {}
                          });
                      } else {
                          console.log('status!=0')
                      }
                  } else {
                      $.alert({
                          title: "系统提示",
                          contentText: "网络异常，分组评分失败！",
                          cancleText: "确定",
                          callback: function(event) {}
                      });
                  }
              },
              error: function(xhr, status) {
                  console.log('error')
              }
          });
        });
        $('#dialog').find('.dialog-close').on('click', function(e) {
            $('#dialog').hide();
        });
        $(document).on("click",".item.team>.item",function(e){
          $('#dialog').data("item",this);
          $('#dialog').show();
        });
    </script>
</body>

</html>
