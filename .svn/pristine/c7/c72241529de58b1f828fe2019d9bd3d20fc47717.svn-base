$(function () {
    //return;
    //从地址栏获取id
    var activityId = window.location.href.match(/activityId=\w+/);
    if (activityId && activityId.length != 0) {
        activityId = activityId[0].split("=")[1] || "";
    }
    if(!!activityId){
        Event.sendEvent("toupiao_"+activityId);

    }
    

    //页面切换方法
    function togglePage(page) {
        $(".page").hide();
        $(page).show();
    }

    //初始化
    $(".page").hide();
    if (!activityId) {
        alert("地址错误!");
        return;
    }
    var phone = localStorage.getItem("phoneyazhu");
    

    //index-page 跳选用户
    $("#index-page button").bind("click", function () {
        console.log(phone);
        $(this).attr('disabled',"true");

        var that=this;
        togglePage($("#bet-page"));
        //获取投注信息
        if (!phone) {
            $(".u10").html("0");
        } else {
            $.get("/eurocup-promo/public/bet/last", {
                phone: phone
            }, function (data) {
                if (!data.errorCode) {
                    console.log(data);
                    $(".u10").html(data.data.uCoin);
                    if(!data.data.matchTitle){
                        return;
                    }
                    $("#alt-page").show();
                    $(".bet-content").html("<p class='info-m'><span class='com-info'>最近下注所赢记录</span></p><p class='info-m'>" + data.data.matchTitle + "</p><p class='info-m'>本次赢得<span class='x'>" + data.data.winAmount + "</span></p>")
                }
            });
        }

        //获取比赛信息
        $.get("/eurocup-promo/public/matches", {
            actId: activityId,
            phone: phone
        }, function (data) {
            if (!data.errorCode) {
                // //获取比赛
                console.log(data.data);
                $(that).removeAttr("disabled");
                var s = "";
                var hamount = "";
                var curentz = "";

                var $swipers = $("#bet-swiper");
                for (var i = 0; i < data.data.matches.length; i++) {

                    var item = data.data.matches[i];
                    //倒计时
                    var currentTime = new Date(Date.now());
                    var offset = (item.day + item.endTime) - currentTime.getTime();
                    if (offset <= 0) {
                        offset = 0;
                    }

                    var betRecord = data.data.matches[i].betRecord !== undefined ? data.data.matches[i].betRecord.team.title : "";
                        hamount = (!data.data.matches[i].betRecord) ? data.data.matches[i].lowestBet : data.data.matches[i].betRecord.amount;

                    var html = "";
                    html += "<div class='swiper-slide' data-matchid='" + data.data.matches[i].objectId + "'><p style='margin-top:1rem'><span class='com-info info-m'>距本次竞猜结束还有</span>";
                    html += "<span class='x retime' data-day='" + data.data.matches[i].day + "' data-endtime='" + data.data.matches[i].endTime + "'>" + ms2hms(offset) + "</span></p>";

                    html += "<div class='bet-station'><div class='blue-station'><div class='imgbox " + (data.data.matches[i].teams[0].title == betRecord ? "curentz" : "") + "' style='background:url(" + data.data.matches[i].teams[0].flag + ");' data-flag='" + data.data.matches[i].teams[0].flag + "' data-title='" + data.data.matches[i].teams[0].title + "'></div><p>" + data.data.matches[i].teams[0].title + "</p></div><span class='vs com-info'>vs</span> <div class='red-station'>";
                    html += "<div class='imgbox " + (data.data.matches[i].teams[1].title == betRecord ? "curentz" : "") + "' style='background:url(" + data.data.matches[i].teams[1].flag + ")' data-flag='" + data.data.matches[i].teams[1].flag + "' data-title='" + data.data.matches[i].teams[1].title + "'></div><p>" + data.data.matches[i].teams[1].title + "</p></div></div><p class='com-info info-s' style='margin-top:0.625rem'>请选择你要投注的U徽章数</p><p class='info-s tz-info'></p>";

                    html += "<div class='range swiper-no-swiping'><span>" + data.data.matches[i].lowestBet + "</span><input type='range' class='rangeopr' min='" + data.data.matches[i].lowestBet + "' max='200' value='" + hamount + "'  step='10'  data-hamout='" + hamount + "'/><span>200</span>";
                    html += "<input type='text' disabled readonly class='rangev' value=' "+ hamount + "'/></div><div class='flex-box'><div class='flex-1'><button class='com-btn reconfim'>重新选择</button></div>";
                    html += "<div class='flex-1'><button class='com-btn comfirm'>确认投注</button></div> </div></div>";


                    var $swiper = $(html);
                    $swipers.append($swiper);
                }
                //初始化swiper
                var swiper = new Swiper('.swiper-container', {
                    slidesPerView: 1,
                    nextButton: '.swiper-button-next',
                    prevButton: '.swiper-button-prev',
                    noSwiping : true,
                    observer:true,//修改swiper自己或子元素时，自动初始化swiper
                    observeParents:true,//修改swiper的父元素时，自动初始化swiper
                });

                $(".imgbox").on("click", function () {
                    $(this).closest(".bet-station").find(".imgbox").removeClass('curentz');
                    $(this).addClass('curentz');

                });

                $(".comfirm,.reconfim").on("click", function () {
                    var rang = $(this).closest(".swiper-slide").find(".rangev").val();
                    var matchId = $(this).closest(".swiper-slide").data('matchid');
                    var obj = {};
                    if (!phone) {
                        $("#register-page").show();
                        return;
                    }
                    $(this).attr('disabled',"true");
                    $(this).html('投注中..');
                    var that=this;
                    obj.title = $(this).closest(".swiper-slide").find(".curentz").data('title');
                    obj.flag = $(this).closest(".swiper-slide").find(".curentz").data('flag');
                    $.ajax({
                        data: {
                            amount: rang,
                            matchId: matchId,
                            phone: phone,
                            team: obj
                        },
                        url: "/eurocup-promo/public/match/bet",
                        type: 'post',
                        dataType: "json",
                        success: function (data) {
                            console.log(data);
                            $(that).removeAttr("disabled").html("确认投注");
                            if(!data.error){
                                $(".u10").html(data.data.uCoin);
                                alert("投注成功");
                                return;
                            }
                            if(data.error.errorCode==5){
                                alert("请先下注");
                            }
                             if(data.error.errorCode==202){
                                alert("U徽章不足");
                            }
                        },
                        error: function () {
                         $(that).removeAttr("disabled");
                        }
                    });
                });

                $("#bet-swiper .swiper-slide .retime").each(function (index) {
                    clearInterval(window['Timer' + index]);
                    window['Timer' + index] = setInterval((function (elem, index) {
                        return function () {
                            var currentTime = new Date(Date.now() + window.DEBUG_TIMEOFFSET);
                            var day = $(elem).data('day');
                            var endtime = $(elem).data('endtime');
                            var offset = (Number(day) + Number(endtime)) - currentTime.getTime();
                            if (offset <= 0) {
                                offset = 0;
                                clearInterval(window['Timer' + index]);
                            }
                            $(elem).html(ms2hms(offset));
                        }
                    })(this, index), 1000);
                });
                 //改变滑杆,改变输入框的值
                $(".rangeopr").bind("change", function () {
                    var sum=parseInt($(".u10").html())+parseInt($(this).data("hamout"));
                    var html="";
                    if(sum==0){
                        html="没有U徽可押注,快去获得U徽章吧!";
                    }
                    else{
                        html="本场最多可押 "+sum+" 枚U徽";
                    }
                    $(this).closest(".swiper-slide").find(".tz-info").html(html);
                    var val = $(this).val();
                    var $rangev = $(this).next().next(".rangev");
                    $rangev.val(val);
                })
            }
        });


        //豪礼列表
        $(".p16").bind("click", function () {
            console.log(phone);
            if(!phone){
                $("#register-page").show();
                return
            }
            $(this).attr('disabled',"true");
            var that=this;
            togglePage($("#cash-page"));
            $.get("/eurocup-promo/public/coupon/list", {
                phone: phone
            }, function (data) {
                console.table(data);
                $(that).removeAttr("disabled");
                var s = "";
                for (var i = 0; i < data.data.length; i++) {
                    s += "<button class='btn" + i + "' data-coupanid='" + data.data[i].objectId + "'>" + data.data[i].title + "</button>";
                }
                s+="<p class='btn4' ></p>";
                $(".cash-btn-lst").html(s);
                 //神秘大奖
                $("#cash-page .btn4").bind("click", function () {
                    $(".bet-content").html("<p class='info-m'><span class='com-info'>决赛将会为您开出神秘大奖!<br>多多关注哦!</span></p>");
                    $("#alt-page").show();

                })
                //兑换豪礼
                $(".cash-btn-lst button").bind("click", function () {
                    var coupanid = $(this).data('coupanid');
                    $.post("/eurocup-promo/public/coupon/exchange", {
                        phone: phone,
                        couponId: coupanid
                    }, function (data) {
                        console.log(data);
                        if(!data.error){$("#alt-page").show();$(".bet-content").html("兑换成功");$(".u10").html(data.data.uCoin);}
                        else{
                            if(data.error.errorCode=='201'){
                                $("#alt-page").show();$(".bet-content").html("<p class='info-m'><span class='com-info'>优惠券兑换失败</span></p>");
                            }else if(data.error.errorCode=='202'){
                                $("#alt-page").show();$(".bet-content").html("<p class='info-m'><span class='com-info'>U徽章余额不足!</span><br><span style='color:#365893'> 快去获取U徽章吧,错过等四年!</span></p>");
                            }else if(data.error.errorCode=='204'){
                                $("#alt-page").show();$(".bet-content").html("<p class='info-m'><span class='com-info'>无效优惠券</span></p>");
                            }else if(data.error.errorCode=='203'){
                                $("#alt-page").show();$(".bet-content").html("<p class='info-m'><span class='com-info'>优惠券兑换失败</span></p>");
                            }else if(data.error.errorCode=='205'){
                                $("#alt-page").show();$(".bet-content").html("<p class='info-m'><span class='com-info'>请先至少参与一场竞猜，先到先得</span></p>");
                            }else{
                                $("#alt-page").show();$(".bet-content").html(data.error.message||"<p class='info-m'><span class='com-info'>优惠券兑换错误</span></p>");
                            }
                        }

                    })
                })
            })
         });
            //关闭对话框
            $("#alt-page .com-btn").bind("click", function () {
                $("#alt-page").hide();
            })

        //获得U徽章
        $("#getu").bind("click",function(){
            //获取投注信息
            if (!phone) {
                $("#register-page").show();
                return;
            } else {
                $.post("/eurocup-promo/public/present", {
                    phone: phone
                }, function (data) {
                    if(data.data.isRepeat==0){
                        $(".u10").html(data.data.uCoin);
                       
                        $("#alt-page").show();
                        $("#alt-page .bet-content").html("<p class='info-m'><span class='com-info'>您获得了"+data.data.uCoin+"U徽章</span></p>");
                    }else{
                        $("#alt-page").show();
                        $("#alt-page .bet-content").html("<p class='info-m'><span class='com-info'>您已经领取过了</span><br><span style='color:#365893'>按规则上的方法可获得更多U徽章<br>错过等四年哟!</span></p>");
                    }


                });
            }

        })
        //U徽章返回
        $("#lean-page #back").bind("click",function(){
            togglePage($("#bet-page"));

        })
        //去获取U币
        $(".left-nav").bind("click",function(){

            togglePage($("#lean-page"));
            if (!phone) {
                $("#register-page").show();
                return;
            }
        })
        //兑奖返回
        $("#cash-page .com-btn").bind("click",function(){
            togglePage($("#bet-page"));

        })
        //手机弹窗关闭
        $("#mobile-close").bind("click",function(){
            $("#register-page").hide();

        })
        //查看赛程返回
        $("#result-page .com-btn").bind("click",function () {
            togglePage($("#bet-page"));
        })
            //查看赛程
            $(".right-nav").bind("click", function () {
                togglePage($("#result-page"));
                $.get("/eurocup-promo/public/match/list", {
                    actId: activityId,
                    phone: phone
                }, function (data) {
                    console.table(data);
                    var s = "";
                    for (var i = 0; i < data.data.length; i++) {

                        var betRecord = !!data.data[i].betRecord ? "已下注" + data.data[i].betRecord.team.title + "," + data.data[i].betRecord.amount : "";
                        var winAmount = !!data.data[i].betRecord ? data.data[i].betRecord.winAmount : "0";
                        var matchdata=new Date(data.data[i].matchDate);
                        if (!!data.data[i].remark) {
                            s += "<li class='flex-box flex-m'><div class='team'><div class='imgbox end' style='background:url(" + data.data[i].teams[0].flag + ");'></div>";
                            s += "<span class='end-state'>" + data.data[i].remark + "</span><div class='imgbox end' style='background:url(" + data.data[i].teams[1].flag + ");'></div></div><div class='flex-1'><span class='end-info'>您赢了</span>";
                            s += "<span class='result-value'>" + winAmount + "枚U徽</span></div></li>";

                        }
                        else {
                            s += "<li class='flex-box flex-m'><div class='team'><div class='imgbox blue' style='background:url(" + data.data[i].teams[0].flag + ");'></div>";
                            s += "<span class='state'>" + matchdata.format('MM/dd') + "</span><div class='imgbox red' style='background:url(" + data.data[i].teams[1].flag + ");'></div></div><div class='flex-1'>" + betRecord + "</div></li>";

                        }
                    }
                    $(".schedule-content").html(s);
                });

            });
            //存手机号码
            $("#register-page #mobile-enter").bind("click", function () {
                var myphone = $("#register-page .ipt").val();
                if (myphone.length == 0) {
                    $(".error").html("说好的手机号呢？");

                    return;
                }
                if (myphone.length != 11) {


                    $(".error").html("手机号不是11位这像话吗？");

                    return;
                }
                var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
                if (!reg.test(myphone)) {
                    $(".error").html("手机号格式错误!");

                    return;
                }
                window.localStorage.setItem("phoneyazhu", myphone);
                phone= window.localStorage.getItem("phoneyazhu");
                $("#register-page .ipt").value="";
                $("#register-page").hide();
            })
        });

})

$('.animated').each(function(index, el) {
    var delay = $(this).attr('data-delay')
    $(this).css({
        animationDelay: delay,
        webkitAnimationDelay: delay
    });
});