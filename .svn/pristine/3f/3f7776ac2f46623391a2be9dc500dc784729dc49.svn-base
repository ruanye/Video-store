/*
 * Simple To Introduction
 *
 * REGISTER JAVASCRIPT FILE
 * 
 * @auther liuzhen
 * @date 16/4/26
 * v 0.0.1
 * Copyright © 2016 重庆市秒差距科技有限公司. All Rights Reserved.
 */
var flag = false;
$(function(){
    getValidCode();
    emptyForm();
    //获取短信验证码
    $('#getSmsCode').bind('click',function(){
        //获取短信验证码
        var $code = $(".hqyz");
        var $Btn = $(this);
        var validCode=true;
        var mobile=$("#myphone").val();
        if(!validateRules.isMobile(mobile)){
            $('#myphone').addClass('input-error error-ico');
            $("#phone_error").removeClass().addClass("error-msg").html("手机号码格式有误，请输入正确的手机号");
            $("#phone_error").show();
            return false;
        }

        $Btn.attr("disabled","disabled").css("cursor","not-allowed");
        $.post(Constant.WEB_ROOT+"/api/teacher/sendSMS",{mobilePhoneNumber:mobile}, function(data) {
            if(data.status != 0){
                $("#sms_error").removeClass().addClass('error-msg').html("验证码发送失败!请稍后重试...");
                $Btn.removeAttr("disabled").css("cursor","auto");
            }else{
                $("#sms_error").removeClass().addClass('succeed-msg').html("验证码发送成功!");
                setTimeout(function(){
                    $("#sms_error").removeClass().html("").hide();
                },5000);
            }
        });
        var time=60;
        if (validCode) {
            validCode=false;
            var t=setInterval(function  () {
                time--;
                $Btn.text(time+"s后重新获取");
                if (time==0) {
                    clearInterval(t);
                    $Btn.text("获取短信验证");
                    $Btn.removeAttr("disabled").css("cursor","auto");
                    validCode=true;
                }
            },1000)
        }
    });
    //手机验证
    $('#myphone').bind('blur', function () {
        var mobile = $("#myphone").val();
        if (validateRules.isNull(mobile)) {
            $("#phone_error").removeClass().html("");
            $("#phone_error").hide();
            return;
        }
        if (!validateRules.isMobile(mobile)) {
            $('#myphone').addClass('input-error error-ico');
            $("#phone_error").removeClass().addClass("error-msg").html("手机号码格式有误，请输入正确的手机号");
            $("#phone_error").show();
            return;
        }
        $("#myphone").removeClass('input-error error-ico').addClass("succeed");
        $('#phone_error').removeClass().html("").hide();
    });
    $('#myphone').bind('focus',function(){
        $('#myphone').removeClass('input-error error-ico succeed');
        $("#phone_error").removeClass().addClass("focus-msg").html("完成验证后，您可以用该手机号码登录和找回密码");
        $("#phone_error").show();
        $('#phone_succeed').removeClass();
    });
    //用户名验证
    $('#username').bind('blur', function () {
        var username = $("#username").val();
        if (username == "") {
            $('#username_error').removeClass("error-msg");
            $("#username_error").hide();
            $('#username_succeed').removeClass();
            return;
        }
        username = strTrim(username);
        var format = validateRules.isRealName(username);
        var format2 = validateRules.betweenLength(username, 2, 20);
        if (!format) {
            $('#username_error').removeClass().addClass("error-msg").html("用户名只能是中文或英文组成");
            $('#username').addClass('input-error error-ico');
            return;
        } else {
            if (!format2) {
                $('#username_error').removeClass().addClass("error-msg").html("用户名长度只能在4-20位字符之间");
                $('#username').addClass('input-error error-ico');
                return;
            }
            $("#username").removeClass('input-error error-ico').addClass("succeed");
            $('#username_error').removeClass().html("").hide();
        }
    });
    $('#username').bind('focus',function(){
        $('#username').removeClass('input-error error-ico succeed');
        $("#username_error").removeClass().addClass("focus-msg").html("4-20位字符，支持汉字和英文");
        $("#username_error").show();
        $('#username_succeed').removeClass();
    });

    //邮箱验证
    $('#myemail').bind('blur', function () {
        var mail = $("#myemail").val();
        if (mail == "") {
            $('#mail_error').removeClass("error-msg");
            $("#mail_error").hide();
            $('#mail_succeed').removeClass();
            return;
        }
        var email = strTrim(mail);
        var format = validateRules.isEmail(email);
        var format2 = validateRules.betweenLength(email, 0, 50);
        if (!format) {
            $('#mail_error').removeClass().addClass("error-msg").html("邮箱地址不正确，请重新输入");
            $('#myemail').addClass('input-error error-ico');
            return;
        } else {
            if (!format2) {
                $('#mail_error').removeClass().addClass("error-msg").html("邮箱地址长度应在4-50个字符之间");
                $('#myemail').addClass('input-error error-ico');
                return;
            }
            $("#myemail").removeClass('input-error error-ico').addClass("succeed");
            $('#mail_error').removeClass().html("").hide();
        }
    });
    $('#myemail').bind('focus',function(){
        $('#myemail').removeClass('input-error error-ico succeed');
        $("#mail_error").removeClass().addClass("focus-msg").html("请输入您的常用电子邮箱地址");
        $("#mail_error").show();
        $('#mail_succeed').removeClass();
    });

    //验证密码
    $('#passworld1').bind('blur', function () {
        var pwd = $("#passworld1").val();
        if (pwd == "") {
            $('#pwd_error').removeClass("error-msg");
            $("#pwd_error").hide();
            $('#pwd_succeed').removeClass();
            return;
        }
        pwd = strTrim(pwd);
        var format = validateRules.isPwd(pwd);
        var format2 = validateRules.betweenLength(pwd, 6, 20);
        if (!format) {
            $('#pwd_error').removeClass().addClass("error-msg").html("密码只能由英文、数字及标点符号组成");
            $('#passworld1').addClass('input-error error-ico');
            return;
        } else {
            if (!format2) {
                $('#pwd_error').removeClass().addClass("error-msg").html("密码长度只能在6-20位字符之间");
                $('#passworld1').addClass('input-error error-ico');
                return;
            }
            $("#passworld1").removeClass('input-error error-ico').addClass("succeed");
            $('#pwd_error').removeClass().html("").hide();
        }
    });
    $('#passworld1').bind('focus',function(){
        $('#passworld1').removeClass('input-error error-ico succeed');
        $("#pwd_error").removeClass().addClass("focus-msg").html("6-20位字符，建议由字母，数字和符号两种以上组合");
        $("#pwd_error").show();
        $('#pwd_succeed').removeClass();
    });

    //验证确认密码
    $('#passworld2').bind('blur', function () {
        var pwd = $("#passworld1").val();
        var pwdRepeat = $("#passworld2").val();
        if (pwdRepeat == "") {
            $('#pwdRepeat_error').removeClass("error-msg");
            $("#pwdRepeat_error").hide();
            $('#pwdRepeat_succeed').removeClass();
            return;
        }
        pwdRepeat = strTrim(pwdRepeat);
        var format = validateRules.isPwd(pwdRepeat);
        var format2 = validateRules.betweenLength(pwdRepeat, 6, 20);
        var format3 = validateRules.isPwdRepeat(pwd, pwdRepeat);
        if (!format) {
            $('#pwdRepeat_error').removeClass().addClass("error-msg").html("密码只能由英文、数字及标点符号组成");
            $('#passworld2').addClass('input-error error-ico');
            return;
        } else {
            if (!format2) {
                $('#pwdRepeat_error').removeClass().addClass("error-msg").html("密码长度只能在6-20位字符之间");
                $('#passworld2').addClass('input-error error-ico');
                return;
            }else{
                if(!format3){
                    $('#pwdRepeat_error').removeClass().addClass("error-msg").html("两次输入密码不一致");
                    $('#passworld2').addClass('input-error error-ico');
                    return;
                }
            }
            $("#passworld2").removeClass('input-error error-ico').addClass("succeed");
            $('#pwdRepeat_error').removeClass().html("").hide();
        }
    });
    $('#passworld2').bind('focus',function(){
        $('#passworld2').removeClass('input-error error-ico succeed');
        $("#pwdRepeat_error").removeClass().addClass("focus-msg").html("请再次输入密码");
        $("#pwdRepeat_error").show();
        $('#pwdRepeat_succeed').removeClass();
    });
    //短信验证码
    $('#yanzhnegma').bind('focus',function(){
        $('#yanzhnegma').removeClass('input-error error-ico succeed');
        $("#sms_error").removeClass().addClass("tip").html("");
        $("#sms_error").hide();
        $('#sms_succeed').removeClass();
    });

    //图片验证码
    $('#regincode').bind('focus',function(){
        $('#regincode').removeClass('input-error error-ico succeed');
        $("#authcode_error").removeClass().addClass("tip").html("");
        $("#authcode_error").hide();
        $('#authcode_succeed').removeClass();
    });

});

//获取验证码
function getValidCode(){
    var code = getCode();
    SS.set(Constant.randomStr, code);
    jQuery('#checkimg').attr('src',Constant.WEB_ROOT+'/xuan/verifyCode?randomStr='+code);
}

function strTrim(str) {
    return str.replace(/(^\s*)|(\s*$)/g, "");
}

function emptyForm(){
    $("#myphone").val("");
    $("#yanzhnegma").val("");
    $("#username").val("");
    $("#myemail").val("");
    $("#passworld1").val("");
    $("#passworld2").val("");
    $("#regincode").val("");
}

function checkVal(){
     var myphone = $("#myphone").val();
     if(myphone == ""){
         $("#myphone").addClass('input-error error-ico');
         $("#phone_error").removeClass().addClass('error-msg').html("请输入手机号！");
         flag = true;
     }
     var yanzhnegma = $("#yanzhnegma").val();
     if(yanzhnegma == ""){
         $("#yanzhnegma").addClass('input-error error-ico');
         $("#sms_error").removeClass().addClass('error-msg').html("请输入短信验证码");
         flag = true;
     }
     var username =$("#username").val();
     if(username==""){
         $("#username").addClass('input-error error-ico');
         $("#username_error").removeClass().addClass('error-msg').html("请输入教师姓名");
         flag = true;
     }
     var myemail = $("#myemail").val();
     if(myemail == ""){
         $("#myemail").addClass('input-error error-ico');
         $("#mail_error").removeClass().addClass('error-msg').html("请输入邮箱");
         flag = true;
     }
     
     var passworld1 = $("#passworld1").val();
     if(passworld1 == ""){
         $("#passworld1").addClass('input-error error-ico');
         $("#pwd_error").removeClass().addClass('error-msg').html("请输入密码");
         flag = true;
     }

     var passworld2 = $("#passworld2").val();
     if(passworld2 == ""){
         $("#passworld2").addClass('input-error error-ico');
         $("#pwdRepeat_error").removeClass().addClass('error-msg').html("请再次输入密码");
         flag = true;
     }
     var regincode = $("#regincode").val();
     if(regincode == ""){
         $("#regincode").addClass('input-error error-ico');
         $("#authcode_error").removeClass().addClass('error-msg').html("请输入验证码");
         flag = true;
     }
    return flag;
}
function reginNow(){
    if(!checkVal()){
        var myphone = $("#myphone").val();
        var yanzhnegma = $("#yanzhnegma").val();
        var username =$("#username").val();
        var myemail = $("#myemail").val();
        var passworld1 = $("#passworld1").val();
        var passworld2 = $("#passworld2").val();
        var regincode = $("#regincode").val();
        var validCode=SS.get(Constant.randomStr);
        var mydata = {telephone:myphone,realName:username,pwd:passworld1,loginName:myphone,email:myemail,validCode:validCode,checkCode:yanzhnegma,code:regincode}
        $.post(Constant.WEB_ROOT+"/api/teacher/register",mydata, function(data) {
            if(data.status==0){
                $.alert({
                    title:"系统提示",
                    contentText:'恭喜您注册成功',
                    cancleText:"确定",
                    callback:function( event ){}
                });
                setTimeout(function () {
                    window.location.href = 'login.html';
                },1500);
            }else{
                $.alert({
                    title:"系统提示",
                    contentText:data.msg,
                    cancleText:"确定",
                    callback:function( event ){}
                });
            }
        });
    }
}

