<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>麦可思 - 作业</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" user-scalable="no">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="css/homework.css">

    <!--[if lt IE9]>
    <script src="js/html5.js"></script>
    <script src="js/IE7.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="w">
      <div id="login">
        <a href="#">
          <img src="images/mycos_logo.png" width="210" height="45">
        </a>
      </div>
    </div>
    <div id="content">
      <div class="" id="container">

      </div>
    </div>
    <div class="w">
      <div class="footer">
        <div class="links">&nbsp;</div>
        <div class="copyright">© Copyright 2016 麦可思 版权所有 | 未经许可不得复制 蓉ICP备152009300号-1</div>
      </div>
    </div>

    <script type="text/javascript" src="js/libs/jQuery/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="js/ss.js"></script>
    <script type="text/javascript" src="js/common.js"></script>

    <script type="text/tmpl" id="downTpl">
      <div class="down">
        <img src="images/file.png" alt=""/>
        <div class="name"><%=window.DATA.homeworkfile.fileName%></div>
        <button onClick="download()">下载</button>
      </div>
    </script>
    <script type="text/javascript">
      function download(){
        var url = window.DATA.homeworkfile.url;
        window.open(url);
      }
      function renderDown(){
        var result = tmpl($("#downTpl").html(),{

        });

        $("#container").html( result );
      }
      // renderDown();
    </script>

    <script type="text/tmpl" id="workTpl">
      <div class="work">
        <div class="content">
        <span calss='seq'><%=data.seq%>、</span>
        <span class='type'><%=['','单选题','多选题','填空题','判断题','问答题'][data.type]%></span>
        <span><%=data.title%></span>
        </div>
        <% if(showType == 'chose'){%>
          <div class="answer chose">
            <%for(var i =0;i<data.answers.length;i++){%>
              <div class="item<%=data.answers[i].chosed?' chosed':''%>" data-answer='<%=data.answers[i].code%>' onclick='choseAnswer(this)'>
                <span class='code'><%=data.answers[i].code%></span>
                <span><%=data.answers[i].content%></span>
              </div>
            <% }%>
          </div>
        <%}%>
        <% if(showType == 'type'){%>
          <div class="answer type">
            <textarea name="" id="" cols="0" rows="5" <%=!!currentPageDate.answerText&&false?'readonly':''%> onClick="choseAnswer(this)"><%=data.answerText || ''%></textarea>
          </div>
        <%}%>

        <div class="footer">
          <button class="prev<%=showPrevBtn?' active':''%>" onclick="go('prev')">上一题</button>
          <button class="next active" onclick="go('next')"><%=showSubmitBtn?'提交':'下一题'%></button>
        </div>
      </div>
    </script>
    <script type="text/javascript">
      function initData( type ){
        if( !window.pageDate){
          $.get(Constant.WEB_ROOT + '/api/homework/checkStudent',{
            homeworkSerialId:GetRequest()['id'],
            StudentNo:SS.get("StudentNo")
          },function(data){
            if(data.status !=0){
              $.alert({
                contentText:data.msg,
              });
              SS.remove("StudentNo");
              renderLogin();
              return;
            };
            window.DATA = data;
            window.pageDate = data.homework;
            // console.table(window.pageDate);

            if( !!data.homeworkfile){
              renderDown();
            }else{
              renderWork(type)
            }
          });
          return false;
        }
        return true;
      }
      function renderWork( type ){
        if( !initData(type) ){
          return;
        }
        var currentPageIndex = window.currentPageIndex || GetRequest()['index'] || 0;
        if( type == 'next'){
          currentPageIndex++;
        }
        if( type == 'prev'){
          currentPageIndex--;
        }
        currentPageDate =  window.pageDate[currentPageIndex];
        if( !currentPageDate.answers){
          try {
            currentPageDate.answers = JSON.parse(currentPageDate.options);
          } catch (e) {
            currentPageDate.answers = [];
          }
        }

        //选中正确答案
        (currentPageDate.answer || '').split(',').forEach(function(item){
          currentPageDate.answers.forEach(function(answer){
            // console.log(answer.code == item,answer.code,item);
            if( answer.code ==  item){
              answer.chosed = true;
            }else{
              answer.chosed = false;
            }
          });
        });
        window.currentPageIndex = currentPageIndex;
        var parames = "";
        var request = GetRequest();
        request.index = currentPageIndex;
        for( var key in request){
          if( !!parames){
            parames+="&";
          }
          parames += key+'='+request[key];
        }
        window.history.replaceState(null,null,'homework.html?'+parames);

        // var showNextBtn = currentPageIndex != window.pageDate.length - 1;
        var showSubmitBtn = currentPageIndex == window.pageDate.length - 1;
        var showPrevBtn = currentPageIndex != 0;
        var result = tmpl($("#workTpl").html(),{
          data:currentPageDate,
          showPrevBtn:showPrevBtn,
          showSubmitBtn:showSubmitBtn,
          studentId:SS.get('studentId'),
          showType:(currentPageDate.type==1||currentPageDate.type==2||currentPageDate.type==4)?'chose':'type'
        });
        $("#container").html( result );
      }

    </script>

    <script type="text/javascript">

      function choseAnswer(that){
        var currentPageDate = window.pageDate[window.currentPageIndex];
        //跳过已答
        if(!!currentPageDate.answer || !!currentPageDate.answerText){
          // alert("不能修改答案")
          // return;
        }
        //单选只能选择一个答案
        if( currentPageDate.type == 1){
          $(".work .answer .item.chosed").removeClass('chosed');
        }
        $(that).toggleClass('chosed');
      }
      function go( type ){
        //获取答案
        var $answer = $(".work .answer");
        var answer = '';
        var currentPageDate = window.pageDate[window.currentPageIndex];
        if($answer.hasClass('chose')){
          var $answers = $answer.find(".item.chosed");
          if($answers.length > 1 && (currentPageDate.type != 2)){
            alert("只能选择一个正确答案");
            return;
          }
          $answers.each(function(){
            answer += $(this).data('answer') +",";
          });
        }
        if( !!answer ){
          answer = answer.substr(0,answer.length-1);
        }
        if($answer.hasClass('type')){
          answer = $answer.find('textarea').val();
        }

        //跳过已答
        // if(!!currentPageDate.answer || !!currentPageDate.answerText){
        //   return;
        // }
        //发送
        $.post(Constant.WEB_ROOT + '/api/homeworkAnswer',{
          answer:answer,
          answerText:answer,
          homeworkItemId:currentPageDate.id,
          homeworkSerialId:GetRequest()['id'],
          studentId:window.DATA.id
        },function(data){
          if(data.status !=0){
            $.alert({
              contentText:data.msg,
            });
            // return;
          }else{
            // debugger;
            currentPageDate.answer = answer;
            currentPageDate.answerText = answer;
          }
          if( type == 'next' && window.pageDate.length-1 == window.currentPageIndex ){
            $.alert({
              contentText:'作业已完成',
            });
            SS.remove("StudentNo");
            renderLogin();
            return;
          }
          renderWork(type);
        });

      }
    </script>

    <script type="text/tmpl" id="loginTpl">
      <div class="login">
        <div class="form-item">
          <div class="label">学号：</div>
          <input type="text"/>
        </div>
        <div class="form-item">
          <div class="label"></div>
          <input type="button" value='登  录' onClick='login()'/>
        </div>
      </div>
    </script>
    <script type="text/javascript">
      function renderLogin(){
        var result = tmpl($("#loginTpl").html());
        $("#container").html( result );
      }

      function login(){
        SS.set('StudentNo',$("#container input").val());
        renderWork();
      }
      if( !SS.get('StudentNo') ){
        renderLogin();
      }else{
        renderWork();
      }
    </script>
  </body>

</html>
