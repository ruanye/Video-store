/* login.index.js Date:2016-04-13 14:04:40 */

$(function() {
    getValidCode();
    
    var msg = SS.get(Constant.loginPageMsg);
    if (msg != null) {
        var b = '<div class="msg-warn"><b></b>' + msg + '</div>';
        $(".msg-wrap .msg-error").hide();
        $(".msg-wrap .msg-warn").show().replaceWith(b);
    } else {
        $(".msg-wrap .msg-warn").hide();
    }

    $("#loginBtn").click(function() {
        var pwd = $("input[name='j_password']").val();
        var loginName = $("input[name='j_username']").val();
        var checkCode = $("input[name='veryCode']").val();
        if(loginName == ""){
            var b = '<div class="msg-warn"><b></b>请输入登录账号</div>';
            $(".msg-wrap .msg-error").hide();
            $(".msg-wrap .msg-warn").show().replaceWith(b);
            return;
        }
        if(pwd == ""){
            var b = '<div class="msg-warn"><b></b>请输入登录密码</div>';
            $(".msg-wrap .msg-error").hide();
            $(".msg-wrap .msg-warn").show().replaceWith(b);
            return;
        }
        if(checkCode == ""){
            var b = '<div class="msg-warn"><b></b>请输入验证码</div>';
            $(".msg-wrap .msg-error").hide();
            $(".msg-wrap .msg-warn").show().replaceWith(b);
            return;
        }

        var params = {
            loginName: loginName,
            pwd: pwd,
            checkCode:checkCode,
            validCode:SS.get(Constant.randomStr)
        };
        $("#loginBtn").attr("disabled","disabled").html("登录中...").css("cursor","not-allowed");
        $.get(Constant.WEB_ROOT+"/api/teacher/login", params, function(data, status) {
            if (status == 'success') {
                if (data.status == 0) {
                    SS.set(Constant.token, data.token);
                    SS.set(Constant.teacherId, data.teacherId);
                    SS.set(Constant.loginName, data.loginName);
                    SS.remove(Constant.expireTime);
                    location.href = "index.html";
                } else {
                	$("#loginBtn").removeAttr("disabled").html("登 &nbsp;&nbsp;&nbsp;&nbsp;录").css("cursor","auto");
                    getValidCode();
                    var b = '<div class="msg-error"><b></b>' + data.msg + '</div>';
			        $(".msg-wrap .msg-warn").hide();
			        $(".msg-wrap .msg-error").show().replaceWith(b);
                }
            } else {
            	$("#loginBtn").removeAttr("disabled").html("登 &nbsp;&nbsp;&nbsp;&nbsp;录").css("cursor","auto");
                getValidCode();
                var b = '<div class="msg-warn"><b></b>' + data.msg + '</div>';
		        $(".msg-wrap .msg-error").hide();
		        $(".msg-wrap .msg-warn").show().replaceWith(b);
            }
        },"json");
    });
});


function getValidCode(){
    var code = getCode();
    SS.set(Constant.randomStr, code);
    jQuery('#checkimg').attr('src',Constant.WEB_ROOT+'/xuan/verifyCode?randomStr='+code);
}

document.onkeydown = function(event) {
	var e = event || window.event || arguments.callee.caller.arguments[0];
	if (e && e.keyCode == 13) {
		$("#loginBtn").click();
	}
};
