
$(function(){
    SS.remove(Constant.current);
    SS.remove(Constant.isMenu);
	//$(".header-title").html(SS.get("userName"));
	$("#lessons-btn").click(function(){
		$(this).parents("div.content").fadeOut("slow");
        var teacherId = SS.get(Constant.teacherId);
        $.get(Constant.WEB_ROOT+'/manager/teacher/timeTable?teacherId='+teacherId, function(data) {
            var amSeqMax = parseInt(data.amSeqMax === undefined ? 0 : data.amSeqMax);
            var pmSeqMax = parseInt(data.pmSeqMax === undefined  ? 0 : data.pmSeqMax);
            var totalTr = amSeqMax + pmSeqMax;
            var amTrNum = amSeqMax;
            var pmTrNum = pmSeqMax;
            if(data.status == "0"){
                var html="";
                $("#course-list-body").html("");
                for (var i = 0; i <= totalTr; i++) {//tr
                    if(i == amTrNum){
                        html+="<tr><td colspan=\"8\" class=\"item-td-hr\"></td></tr>"
                    }else{
                        html+="<tr class=\"course-item\">";
                        for (var k = 0; k < 8; k++) { //td
                            if(k==0){
                                html+="<td class=\"item-td\">"+(i< amTrNum ? ( i + 1 ): i)+"</td>"
                            }else{
                                var value = "",className="";
                                for (var j = 0; j < data.array.length; j++) {
                                    var obj = data.array[j];
                                    var dayOfWeek = -1;
                                    var seq = -1; //序号
                                    var trSep = 1;//课表序号
                                    var ampm = 1; //区分上下午 1上午 2 下午
                                    if(obj !== undefined){
                                        dayOfWeek = obj.dayOfWeek === undefined ? -1 : obj.dayOfWeek;
                                        seq = obj.seq === undefined ? -1 : obj.seq;
                                        ampm = obj.ampm === undefined ? 1 : obj.ampm;
                                    }

                                    if(ampm == 1){
                                        trSep = seq;
                                    }else{
                                        trSep = amTrNum + seq;
                                    }
                                    var $tr = (i< amTrNum ? ( i + 1 ) : i);
                                    if(trSep == $tr){//x
                                        if(dayOfWeek == k){ //y
                                            className="select";
                                            value+="<p class=\"bookName\">"+obj.courseName+"</p><p class=\"className\">"+(obj.className === undefined ? "" :obj.className)+"</p><p class=\"addressName\">"+(obj.address === undefined ? "" :obj.address)+"</p>"+
                                            "<input type=\"hidden\" name=\"courseId\" value=\""+obj.courseId+"\"/>"+
                                            "<input type=\"hidden\" name=\"classId\" value=\""+obj.classId+"\"/>"+
                                            "<input type=\"hidden\" name=\"timetableId\" value=\""+obj.id+"\"/>";
                                        }
                                    }
                                }
                                html+="<td class=\"item-td "+className+"\">"+value+"</td>";
                            }
                        }
                        html+="</tr>"
                    }
                }

                $("#course-list-body").html(html);
                $(".course").fadeIn("slow");

                $(".select").bind("click",function(){
                    var bookName = $(this).find(".bookName").html();
                    var className = $(this).find(".className").html();
                    //className
                    var courseId = $(this).find("input[name='courseId']").val();
                    var classId = $(this).find("input[name='classId']").val();
                    var timetableId = $(this).find("input[name='timetableId']").val();
                    SS.set(Constant.courseId,courseId);//课程ID
                    SS.set(Constant.bookName,bookName);//课程名称
                    SS.set(Constant.classId,classId);//班级ID
                    SS.set(Constant.timetableId,timetableId);//课表ID
                    $.confirm({
                        title:"上课提示",
                        contentText:"确定要开启'"+bookName+"' - '"+className+"'课程吗?",
                        submitText:"开始上课",
                        callback:function( event ){
                            switch ( event.index ) {
                                case 0:
                                    break;
                                case 1:
                                    LESSONS.openClassRoom();
                                    break;
                            }
                        },
                    });
                });
            }else{
               $.alert({
                    title:"系统提示",
                    contentText:"网络异常，加载课程表信息失败！",
                    cancleText:"确定",
                    callback:function( event ){}
                });
            }
        },"json");
	});
	$("#after-class-btn").click(function(){
        // $.alert({
        //     title:"系统提示",
        //     contentText:"此功能正在开发中...",
        //     cancleText:"确定",
        //     callback:function( event ){}
        // });
        window.location.href = "admin/index.html"
	});
});

var LESSONS = {
    openClassRoom:function(){
        var params = {
        teacherId: SS.get(Constant.teacherId),//教师ID
        timetableId: SS.get(Constant.timetableId)//课表ID
        };
        //开启课堂
        $.get(Constant.WEB_ROOT+"/manager/teacher/timeTableSerial", params, function(data, status) {
            if(status == "success"){
                if(data.status == 0){
                    SS.set(Constant.isMenu,"false");
                    SS.set(Constant.baseCourseId,data.obj.baseCourseId);//基础课程ID
                    SS.set(Constant.courseId,data.obj.courseId);//基础课程ID
                    SS.set(Constant.timeTableSerialId,data.obj.id);//课堂流水ID
                    SS.setObj(Constant.sign,data.obj);//签到信息
                    if(data.obj.signStatus == 0){
                        SS.set(Constant.isCheck,0);//开启
                    }else{
                        SS.set(Constant.isCheck,1);//关闭
                    }
                    location.href = "main.html";

                }else{
                    $.alert({
                        title:"系统提示",
                        contentText:"网络异常，课堂开启失败，请稍后重试...",
                        cancleText:"确定",
                        callback:function( event ){}
                    });
                }
            }else{
                $.alert({
                    title:"系统提示",
                    contentText:"网络异常，课堂开启失败，请稍后重试...",
                    cancleText:"确定",
                    callback:function( event ){}
                });
            }
        },"json");
    }
}
