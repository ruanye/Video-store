/**
 * Created by yanghc on 16/5/27.
 */

var EC = {
    init:function() {
        var uid = localStorage.getItem(Constants.userid);
        // var uid = 1;

        //点击保存
        $(document).on('click', '.col-100', function () {
            var isSelected = $("#isLicense").attr("checked");
            var carName = $("#carName").val();
            var carNumber;
            if (carName == null || carName == "") {
                $.alert("请输入车主姓名");
                return;
            }
            //isSelected为true表示新车未上牌
            if (isSelected) {
                // $.alert("新车未上牌");
                LS.set("isSelected", "1");
                var user = {
                    "ownerName": carName,
                    "userId": uid
                }
                LS.setObj("user", user);
                //跳转到补录信息页面
                window.location.href = 'price-input.html';
            } else {
                LS.set("isSelected", "0");
                //新车已上牌,验证车牌号
                carNumber = $("#carNumber").val();
                if (carNumber == null || carNumber == "") {
                    //$.toast("新车未上牌");
                    $.alert("请输入车牌号码");
                    return;
                }

                $.showPreloader('保存中....');
                //查询车牌号
                $.ajax({
                    url: 'http://synsunny.parsec.com.cn/Dorado/weixin/trade/findVehicle',
                    type: 'get',
                    // timeout: 5000,
                    // dataType:'json',
                    data: "lpn="+ carNumber,
                    success: function(data, status) {
                        console.log(data);
                        var user;
                        if (status == 'success' && data.status == 0) {
                            user = data.vehicle;
                            if (user == null) {
                                user = {
                                    "lpn": carNumber,
                                    "ownerName": carName,
                                    "userId": uid
                                }
                            }else {
                                user.ownerName = carName;
                                user.userId = uid;
                            }
                        } else {
                            user = {
                                "lpn": carNumber,
                                "ownerName": carName,
                                "userId": uid
                            }
                        }
                        LS.setObj("user", user);

                        $.hidePreloader();
                        //跳转到补录信息页面
                        window.location.href = 'price-input.html';
                    },
                    error: function(err) {
                        $.hidePreloader();
                        console.log(err);
                        $.toast("保存失败");
                    }
                })
            }

        });

        //选择新车没有上牌多选框
        //验证车牌号码是否已经填写,若已经填写
        $('#isLicense').bind('change', function () {
            var isSelected = $(this).attr("checked");
            if (isSelected) {
                $("#carNumber").val("");
                $("#carNumber").attr("disabled", true);
            }else {
                $("#carNumber").removeAttr("disabled");
                $.alert("请输入车牌号码");
            }
            LS.set(Constants.isLicense, isSelected ? true : false);
        });


        $.init();
    }
}

EC.init();