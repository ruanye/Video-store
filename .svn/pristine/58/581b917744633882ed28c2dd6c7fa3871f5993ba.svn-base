/**
 * Created by zhangji on 16/6/11
 */

var SET = {
    userInfo:{
        headimgurl:'',
        nickname:''
    },
    tokenInfo:{
        token:''
    },
    init:function() {
        var _this=this;
        $.init();
        $("#page-ownerbargain").hide();
        $("#page-friendbargain").hide();
        $("#page-bargain").show();

        $('#dialogShow').on('click',function(e){
            $(this).hide()
        })
        //获取用户信息
        _this.tokenInfo.token=sessionStorage.token;
        sessionStorage.removeItem('token');
        $.ajax({
            type:'get',
            url:Constants.hostIp+'/weixin/sns/userinfo',
            data:{
                openid:LS.get(Constants.openid),
                token:_this.tokenInfo.token
            },
            success:function(data,status){
                console.log(data);
                if(status=='success'){
                    _this.userInfo.headimgurl=data.headimgurl;
                    _this.userInfo.nickname=data.nickname;
                }else{
                    $.alert(data.msg)
                }
            },
            error:function(){
                // alert('err')
            }
        })
        $('#cutPay').on('click',function(e){
            var data={
                ip:document.querySelector("#keleyivisitorip").innerHTML,
                openid:LS.get(Constants.openid),
                orderId:sessionStorage.orderId,
                paymethod:1
            }
            console.log(data);
            $.ajax({
                type:'post',
                url:Constants.hostIp+'/weixin/readypay',
                data:data,
                success:function(data,status){
                    console.log(data);
                    if(data.status==0){
                        js_params=data.jsapi
                        paybill(function(){
                            //成功后的回掉
                            location.href="policyList.html"
                        },function(){
                            //失败后或者取消后的回掉
                            //do somethings
                        })
                    }else{
                        $.alert(data.msg)
                    }
                },
                error:function(){
                    // $.alert('err')
                }
            })     
        })
        //朋友砍价
        $('#friendCut').on('click',function(e){
            var orderId=_this.GetRequest()['orderId']
            var orderCode=_this.GetRequest()['orderCode']
            $.ajax({
                type:'get',
                url:Constants.hostIp+'/weixin/trade/chaffer',
                data:{
                    icon:_this.userInfo.headimgurl,
                    nickname:_this.userInfo.nickname,
                    openid:LS.get(Constants.openid),
                    orderCode:orderCode
                },
                success:function(data,status){
                    console.log(data);
                    if(data.status==0){
                        $.alert('成功砍价'+data.chafferMoney/100)
                        // location.reload()
                        var s='';
                        for (var i=0;i<data.list.length;i++) {
                            var tmp = data.list[i];
                            s += '<li class="flex-m">'+
                                        '<div class="user-photo" style="background-image:url('+tmp.icon+')"></div>'+
                                        '<div class="bargain-lst-detail flex-1">'+tmp.nickname+'    成功帮忙砍掉   '+(tmp.chafferMoney/100)+' 元</div>'+
                                  '</li>';
                        }
                        $(".bargain-lst-2").html(s);
                    }else{
                        $.alert(data.msg)
                    }
                },
                error:function(){

                }
            })
        })
        $(".total-price").html("￥"+(SET.GetRequest()['total'] || (sessionStorage.priceTotal/100)));
        $(".cm-price").html(sessionStorage.commercialInsurance / 100);
        $(".bz-price").html(sessionStorage.compulsoryInsurance / 100);
        $(".tax-price").html(sessionStorage.tax / 100);
        var chafferTotle = 0;

        var orderId=sessionStorage.orderId||_this.GetRequest()['orderId']
        $.get("http://synsunny.parsec.com.cn/Dorado/weixin/trade/listChaffer?orderId="+orderId, null, function(data) {
            var s = "";
            for (var i=0;i<data.list.length;i++) {
                var tmp = data.list[i];
                s += '<li class="flex-m">'+
                            '<div class="user-photo" style="background-image:url('+tmp.icon+')"></div>'+
                            '<div class="bargain-lst-detail flex-1">'+tmp.nickname+'  成功帮忙砍掉  '+(tmp.chafferMoney/100)+' 元</div>'+
                      '</li>';
                chafferTotle += tmp.chafferMoney;
            }
            $(".bargain-lst-1").html(s);
            $(".bargain-lst-2").html(s);
            $(".bargained-price").html((parseInt(sessionStorage.priceTotal)-chafferTotle) / 100);
            $("#chaffer-price").html(chafferTotle / 100);
            $("#owner-name").html(data.nickName);
        });

        if (!sessionStorage.company) {
            $.get("http://synsunny.parsec.com.cn/Dorado/weixin/buyoutPrice",{
                insuranceCompanyId:sessionStorage.selectedCompanyId,
                commercialPrice:sessionStorage.commercialInsurance,
                taxPrice:parseInt(sessionStorage.compulsoryInsurance)+parseInt(sessionStorage.tax)
            }, function(data) {
                $("#direct-price").html("￥"+data.price/100);
                $("#real-price").html("￥"+data.price/100);
            });
        }

        if (sessionStorage.company) {
            var companyObj = JSON.parse(sessionStorage.company);
            $(".company-icon").html('<img src="'+companyObj.icon+'" alt="">');
            $("#company-name").html(companyObj.name);
            $("#direct-price").html("￥"+companyObj.price);
            $("#real-price").html("￥"+companyObj.price);
        } else {
            var companyId=_this.GetRequest()['company'] || 1;
            $.get("http://synsunny.parsec.com.cn/Dorado/weixin/trade/findBid?commercialInsurance=100000&compulsoryInsurance=0&insuranceCompanyId=0&tax=0", null, function(data) {
            var lst = data.bid.insuranceCompanyBidList;
            for (var i=0;i<lst.length;i++) {
                if (lst[i].companyId == companyId) {
                    $(".company-icon").html('<img src="'+lst[i].icon+'" alt="">');
                    $("#company-name").html(lst[i].name);
                    break;
                }
            }
            });
        }
        if(_this.orderIdjudge()){
            openFriendBargain2();
        }
    },
    orderIdjudge:function(){
        var orderId = window.location.href.match(/orderId=\d+/);
        if (orderId && orderId.length != 0 ){
            orderId = orderId[0].split("=")[1] || 0;
        }
        return orderId
    },
    //url请求参数
    GetRequest:function() {
        var url = location.search;
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = (strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }
};


$(function(){
    if(!sessionStorage.token){
        LS.set(Constants.sourceURL, location.href);
        location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa649d49298a079ff&redirect_uri=http://synsunny.parsec.com.cn/Dorado/weixin/redirect_uri&response_type=code&scope=snsapi_userinfo&state=kanjia#wechat_redirect";
    }
    //初始化
    SET.init();
    var shareObj={
        link:"http://synsunny.parsec.com.cn/DoradoWeb/bargain.html?orderId="+sessionStorage.orderId+"&orderCode="+sessionStorage.orderCode+"&total="+(sessionStorage.priceTotal/100),
        title:'帮好友砍价',
        desc:'帮好友砍价',
        imgUrl:'http://synsunny.parsec.com.cn/DoradoWeb/images/shareIcon.png'
    }
    wx.ready(function(){
        wx.onMenuShareAppMessage({
            title:shareObj.title , // 分享标题
            desc: shareObj.desc, // 分享描述
            link: shareObj.link, // 分享链接
            imgUrl: shareObj.imgUrl, // 分享图标
            type: 'link', // 分享类型,music、video或link，不填默认为link
            success: function () {
                $('#dialogShow').hide()
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });
        wx.onMenuShareTimeline({
            title: shareObj.title, // 分享标题
            link: shareObj.link, // 分享链接
            imgUrl: shareObj.imgUrl, // 分享图标
            success: function () {
                $('#dialogShow').hide()
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });
    })
    wx.error(function(){
        // alert('err')
    })
})

function openFriendBargain() {
    $("#page-ownerbargain").show();
    $("#page-friendbargain").hide();
    $("#page-bargain").hide();
}

function openFriendBargain2() {
    $("#page-ownerbargain").hide();
    $("#page-friendbargain").show();
    $("#page-bargain").hide();
}

function openOwnerBargain() {
    window.location.href = "policyDetail.html";
}

function friendShare() {
    if(!SET.orderIdjudge()){
        $('#dialogShow').show()
        // window.location.href = "bargain.html?orderId="+sessionStorage.orderId+"&orderCode="+sessionStorage.orderCode;
    }
}

