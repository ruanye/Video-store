<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>测试</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" user-scalable="no">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="css/tests.css">

    <!--[if lt IE9]>
    <script src="js/html5.js"></script>
    <script src="js/IE7.js"></script>
    <![endif]-->
</head>

<body>
    <header>
        <nav id="header_menu">
        </nav>
    </header>
    <div class="header-fixed">
        <nav id="header_menu_fixed">
        </nav>
    </div>


    <section class="container">
        <div class="top">
            <div class="btn back" onclick="javascript:window.location='tests-push.html'"><a href="javascript:void(0);">返回</a></div>
            <div class="btn close" onclick="closeX()"><a href="javascript:void(0);">关闭答题</a></div>
        </div>
        <div class="left"></div>
        <div class="right"></div>
        <div style="clear:both;"></div>
    </section>
    <script type="text/javascript" src="js/ss.js"></script>
    <script type="text/javascript" src="js/libs/jQuery/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="js/ls.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/libs/jQuery/QRcode/jquery.qrcode.min.js"></script>

    <!-- 左侧二维码开始 -->
    <script type="text/tmpl" id="leftTpl">
        <div class="qr">
        </div>
        <div class="text"><%= data.text%></div>
    </script>
    <script type="text/javascript">
        (function(){
            var result = tmpl($("#leftTpl").html(),{
                data:{
                    qr:"http://tool.oschina.net/action/qrcode/generate?data=http%3A%2F%2Fostools.net%2Fqr&output=image%2Fgif&error=H&type=0&margin=0&size=4",
                    text:"MYKCTS"
                }
            });
            $(".container > .left").html( result );
        })();
    </script>
    <!-- 左侧二维码结束 -->

    <!-- 右侧题目列表开始 -->
    <script type="text/tmpl" id="rightTpl">
        <div class="items">
        <% for(var i = 0;i < data.item.length;i++){%>
            <div class="item">
                <div class="left">
                    <div class="content"><%=data.item[i].subjectCode+"、"+data.item[i].title%></div>
                    <div class="answer">
                        <% for(var j = 0;j < data.item[i].answer.length && data.item[i].isHide !='hide';j++){%>
                          <div class="item" title="<%=data.item[i].answer[j].content%>">
                            <%=data.item[i].answer[j].code+"、"+data.item[i].answer[j].content%>
                          </div>
                        <%}%>
                        <div style="clear:both;"></div>
                    </div>
                    <div class="progress" data-id="<%=data.item[i].id%>">
                        <div class="percent" ></div>
                        <div class="text">--/--</div>
                    </div>
                </div>
                <div class="right">
                    <div class="result" onclick="window.location.href='tests-result.html?id=<%=data.item[i].id%>&ttSerialId=<%=request['ttSerialId']%>&exerciseSerialId=<%=request['exerciseSerialId']%>'">
                         <a>查看结果</a>
                    </div>
                </div>
                <div style="clear:both;"></div>
            </div>
        <%}%>
        </div>
        <!-- <div class="result-all"  onclick="showAll();"><a>查看全部结果</a></div> -->
    </script>
    <script type="text/javascript">
        var request = GetRequest();
        (function(){
            setInterval(function(){
              $.get(Constant.WEB_ROOT+"/manager/teacher/exercise/answer/progress",{
                  exerciseSerialId:request['exerciseSerialId']
              },function( data ){
                if( data.status != 0){
                  return ;
                }
                (data.lst ||[]).forEach(function(item){
                  var $progress = $(".progress[data-id='"+item.subjectId+"']");
                  $progress.find(".percent").css({
                    width:(item.answerStudentNum/item.totalStudentNum*100)+"%"
                  });
                  $progress.find(".text").html(item.answerStudentNum+"/"+item.totalStudentNum);
                });
              });
            },1000);
            $.get(Constant.WEB_ROOT+"/manager/teacher/exercise/subject/list",{
                exerciseId:request['exerciseId'],
                pageNo:1,pageSize:999
            },function( data ){
                // console.table( data.lst );
                var result = tmpl($("#leftTpl").html(),{
                    data:{
                        qr:"",
                        text:request['displayCode']
                    }
                });
                $(".container > .left").html( result );
                $(".qr").qrcode({
                    height:300,
                    width:300,
                    text:Constant.WX_HTTPPREFIX +"qrcode.html?type=exercise&qrcode="+request['displayCode'],
                });

                //把答案列表Json转换为对象
                data.lst.forEach(function(item){
                    //隐藏填空题
                    switch ( item.subjectType ) {
                        case 1:case 2:case 4:
                            break;
                        case 3:case 5:
                            item.isHide = "hide";
                            break;
                        default:
                    }
                    try{
                        item.answer = JSON.parse(item.itemJson);
                    }catch(e){
                        item.answer = [];
                    }
                });

                var result = tmpl($("#rightTpl").html(),{
                    data:{
                        item:data.lst,
                    }
                });

                SS.set("ttSerialIds",(data.lst || []).filter(function(item){
                  // return !(item.isHide == "hide");
                  return true;
                }).map(function(item){
                  return item.id;
                }).join(","));

                $(".container > .right").html( result );
            });

        })();
    </script>
    <!-- 右侧题目列表结束 -->
    <script type="text/javascript">
        function closeX(){
            $.post(Constant.WEB_ROOT+"/manager/teacher/exercise/serial/close",{id:request['exerciseSerialId']},function( data ){
                if( data.status === 0){
                    window.location.href ="tests-push.html";
                }else{
                    $.alert({
                        title:"测试提示",
                        contentText:"关闭失败，请稍后重试...",
                        submitText:"确定",
                        callback:function( event ){}
                    });
                }
            });
        }
        function showAll(){
            //TODO something
        }
    </script>
</body>
</html>
