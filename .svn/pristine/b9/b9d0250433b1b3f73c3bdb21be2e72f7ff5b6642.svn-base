$(function() {
    //抢券结果
    var result = ['20元礼包', '40元礼包', '30元礼包', '50元礼包']
    var result = [{
        name: '【2次12元】乘车减免',
        title: '【最强战队】'
    }, {
        name: '【1次12元】乘车减免',
        title: '【战斗时刻】'
    }, {
        name: '【2次10元】乘车减免',
        title: '【呼叫使命】'
    }, {
        name: '【1次10元】乘车减免',
        title: '【星球卫士】'
    }]
    $('#page1').height($(document).height())
    $('#page1 .game-start').on('click', function() {
        Coupon.save()
    })
    $('#play').on('click', function() {
        $('.wrap-page').hide();
        $('#last-time').show()
        $('#book_num').show()
        $('#page2').hide()
        initGame()
        pageInitGame()
    })
    $('#page3 .moreChance').on('click', function() {
        $('#page3').hide()
        $('#page4').show()
    })
    $('#share').on('click', function() {
        $('#page4 .dialog').show()
    })
    $('#page4 .dialog').on('click', function() {
        $(this).hide()
    })
    var Coupon = {
        actId: null,
        data: '',
        //保存
        save: function(toflag, money) {
            var _this = this;
            var phoneNumber = $("#phoneNumber").val();
            if (phoneNumber.length == 0) {
                $("#errorInfo").html("<font color='#000'>请填写手机号码</font>");
                return;
            }
            if (phoneNumber.length != 11) {
                $("#errorInfo").html("<font color='#000'>请填写有效的手机号码</font>");
                return;
            }
            var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
            if (!reg.test(phoneNumber)) {
                $("#errorInfo").html("<font color='#000'>请填写有效的手机号码</font>");
                return;
            }
            $('#save_btn').attr('disabled', 'disabled').html('获得中...');
            $.post('/onecoupon/save/' + Coupon.actId + "-" + phoneNumber, {}, function(data) {
                console.log(data);
                if (data.robstatus == 1) {
                    location.href = "https://get.uber.com.cn/invite/icecreamnew"
                } else if (data.status == 1) {
                    $("#page1").hide();
                    $("#page2").show();
                }
            });
        }
    }

    $(document).ready(function() {
        var request = GetRequest();
        Coupon.actId = request['id'];
        if (Coupon.actId) {
            Event.sendEvent("counpon_" + Coupon.actId);
        } else {
            //结束界面
            // $("#page1").hide();
            // $("#page11").show();
        }
    });

    //游戏时间
    var surplusSecond = 0;

    //过关字符串
    var targetMsg = "Uber";
    //临时字符串
    var tempMsg = "";
    //计数
    var num = 0;
    var msgindex = 0;
    var $width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
    var $height = window.innerHeight - 80 || document.documentElement.clientHeight - 80 || document.body.clientHeight - 80;

    // book对像
    var logos = new Array();
    for (var i = 0; i < 2; i++) {
        logos[i] = new Image();
        var index = "";
        index = i;
        logos[i].src = "images/jie-game/shu/book" + index + ".png";
        logos[i].className = "book1";
        logos[i].speed = 10;
        switch (i) {
            case 0:
                logos[i].value = i;
                break;
            case 1:
                logos[i].value = i;
                break;
            case 2:
                logos[i].value = i;
                break;
            default:
                logos[i].value = 0;
        }
    }


    var heroImg = new Image();
    heroImg.src = "images/jie-game/car.png";

    var bg = new Image();
    bg.src = "images/jie-game/page2-bg.png";



    // book类;
    function Book(x, y, speed, img) {
        // 每次循环增加的像素数
        this.speed = speed;
        this.x = x;
        this.y = y;
        this.width = $width * (img.width / 640);
        this.height = $width * (img.height / 640);
        this.img = img;
        this.value = img.value;
    }

    Book.prototype = {
            draw: function(ctx) {
                ctx.drawImage(this.img, this.x, this.y, this.width, this.height);
            },
            move: function() {
                this.y += this.speed;
            }
        }
        // 主角
    function Hero(x, y, img) {
        this.grade = 0;
        this.life = 1;
        this.x = x;
        this.y = y;
        this.img = img;
        this.width = $width * (img.width / 640);
        this.height = $width * (img.height / 640);
    }

    var idx = 0;

    Hero.prototype = {
        draw: function(ctx) {
            ctx.drawImage(heroImg, this.x, this.y, this.width, this.height);
        },
        touch: function(other) { //碰撞检测 this.hero.life--;
            var tmpY = other.y + other.height;
            if (this.x + this.width > other.x && this.x < other.x + other.width &&
                this.y + this.height / 5 > other.y && this.y < tmpY) {
                this.grade++;
                return true;
            }
            return false;
        }
    }
    var App = {

        // 对象
        elements: [],
        backImg: bg,
        imgs: logos,
        hero: null,
        // 画布
        canvas: null,
        // 绘制工具
        context: null,

        frontCanvas: null,

        frontContext: null,

        // 定时器
        timer: null,
        // 速度（更新间隔speed * 10）
        speed: 0,
        pause: false,
        // 绘制对象
        draw: function() {
            // 清屏
            this.context.clearRect(0, 0, this.canvas.width, canvas.height);
            // 绘制背景
            this.context.drawImage(this.backImg, 0, 0, this.canvas.width, this.canvas.height);


            // 绘制娃娃脸
            this.hero.draw(this.context);
            // 绘制金币
            for (var i = 0; i < this.elements.length; i++) {
                var o = this.elements[i];
                // 清理屏幕外的对象
                //
                if (o.x > this.canvas.width || o.x < 0 || o.y > this.canvas.height || o.y < 0) {
                    this.elements.splice(i, 1);
                    // App.gameOver();
                } else if (this.hero.touch(o)) {
                    this.elements.splice(i, 1);
                    document.getElementById("book_num").innerHTML = '分数：' + this.hero.grade;
                } else {
                    o.draw(this.context);
                }
            }

            //绘制缓存
            drawBuffer(this.frontContext, this.frontCanvas, this.context, this.canvas);
        },
        // 循环处理
        loop: function() {
            var me = App;
            if (me.pause) {
                return;
            }
            for (var i = 0; i < me.elements.length; i++) {
                me.elements[i].move();
            }
            var chance = Math.random() * 9000;
            // 1/10的对象添加概率

            //物品出现的几率
            if (chance < 400) {
                var img = {};
                if (num % 4 == 0) {

                    if (me.imgs.length - 1 == num / 4) {
                        num = 0;
                    }
                    img = me.imgs[msgindex];
                    console.log("imgs", img.src);
                    var x = Math.random() * (me.canvas.width - me.imgs[parseInt(chance % me.imgs.length)].width);
                    var y = 0;
                    var speed = img.speed;
                    var book = new Book(x, y, speed, img);
                    me.addElement(book);

                }
                img = me.imgs[parseInt(chance % me.imgs.length)];

                var x = Math.random() * (me.canvas.width - me.imgs[parseInt(chance % me.imgs.length)].width);
                var y = 0;
                var speed = img.speed;
                var book = new Book(x, y, speed, img);
                me.addElement(book);
                num++;
            }

            me.draw();

        },
        // 开始游戏
        gameStart: function(id, speed) {
            console.log("gameStart");
            var me = this;

            //前景界面
            me.frontCanvas = document.getElementById(id);
            me.frontContext = me.frontCanvas.getContext("2d");

            //缓存界面
            me.canvas = document.createElement("canvas");

            me.canvas.width = me.frontCanvas.width;
            me.canvas.height = me.frontCanvas.height;
            me.context = me.canvas.getContext("2d");

            me.speed = speed;
            console.log("heroImg", heroImg);
            me.hero = new Hero((me.canvas.width - heroImg.width) / 2, me.canvas.height - $width * (heroImg.height / 640), heroImg);



            //汽车移动处理
            function touchmove(e) {
                var touchobj = e.changedTouches[0];
                //touchobj = window.event || touchobj;
                var x = touchobj.clientX - me.frontCanvas.offsetLeft - me.hero.width / 2;
                if (x > 0 && x < me.frontCanvas.width - me.hero.width) {
                    me.hero.x = x;
                }
                e.preventDefault();
            }

            me.frontCanvas.addEventListener("touchmove", touchmove);


            me.timer = setInterval(me.loop, me.speed * 10);
            //游戏时间
            surplusSecond = 10;
            window.clearInterval(interval);

            interval = setInterval(function() {
                surplusSecond--;
                var lasttime = '剩余：' + surplusSecond + '秒'
                $('#last-time').html(lasttime);
                if (surplusSecond <= 0) {
                    clearInterval(interval);
                    App.gameOver();
                    $('#canvas').hide()
                    $('.wrap-page').show()
                    $('#page3').show()
                    $('#last-time').hide()
                    $('#book_num').hide()
                    $('#page3 .result-text .p2').text(result[~~(Math.random() * 4)].name)
                    $('#page3 .result-text .p5').text(result[~~(Math.random() * 4)].title)
                }
            }, 1000);
        },
        // 暂停游戏
        gamePause: function() {
            this.pause = true;
            this.context.textAlign = "center";
            this.context.fillStyle = "#f00";
            this.context.font = 'bold 40px Arial';
            this.context.fillText("暂停", this.canvas.width / 2, this.canvas.height / 2);
            this.context.font = 'bold 20px/1.5 Arial';
            this.context.fillText("点击屏幕继续", this.canvas.width / 2, this.canvas.height / 2 + 40);
        },
        // 结束游戏
        gameOver: function() {
            console.log("gameOver");
            clearInterval(this.timer);
            console.log(this.hero.grade);
            this.elements = [];
            this.pause = false;
            this.timer = null;
            this.context.textAlign = "center";
            this.context.fillStyle = "#f00";
            this.context.font = 'bold 20px/1.5 Arial';
            if (this.hero.grade == 0) {
                this.context.fillText("真可惜,再试一次吧...", this.canvas.width / 2, this.canvas.height / 2);
            } else {
                this.context.fillText("游戏结束，恭喜您接到" + this.hero.grade + "本图书", this.canvas.width / 2, this.canvas.height / 2);
            }

            var rank = -1;
            if (this.hero.grade < 1000) {
                rank = 3;
            } else if (this.hero.grade < 1500) {
                rank = 2;
            } else {
                rank = 3;
            }
            drawBuffer(this.frontContext, this.frontCanvas, this.context, this.canvas);
            setTimeout(function() {
                localStorage.setItem("score", App.hero.grade);
                // $("#page3").hide();
                // $("#page4").show();
                // getGameScore();
                // document.getElementById("page3").style="display: none";
                // document.getElementById("page4").style="display:block ;display: -webkit-box;display: -webkit-flex;display: -ms-flexbox;display: flex;";
            }, 2000);

            //document.onclick =  function(){

            //}

        },
        // 添加对象
        addElement: function(o) {
            this.elements.push(o);
        }
    }



    var interval = 0;

    // window.onload = function() {
    //     setTimeout("initGame()", 100);
    // }
    function initGame() {
        console.log("initGame");
        var can = document.createElement("canvas");

        //document.getElementById("canvas");

        can.width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        can.height = document.documentElement.clientHeight
        can.id = "canvas";
        document.body.appendChild(can);

        var foot_div = document.createElement("div");
        var foot_html = "<div class=\"foot-bar\"></div>";
        foot_div.innerHTML = foot_html;
        foot_div.className = "newDiv";
        document.getElementById("page3").appendChild(foot_div);


        var top_div = document.createElement("div");
        var top_html = "<div class=\"right-round\"><p><span style='background: none;color: black;' id=\"last-time\">剩余30秒</span><br><span id=\"book_num\">00</span>本</p></div>";
        top_div.innerHTML = top_html;
        top_div.className = "newDiv";
        document.querySelector(".wrap-page").appendChild(top_div);


        var ctx = can.getContext("2d");
        console.log(can.height);
        ctx.drawImage(bg, 0, 0, can.width, can.height);

        //计算汽车大小
        //heroImg.width =can.width * 0.29;
        //heroImg.height = can.width * 0.06875;
        ctx.drawImage(heroImg, (can.width - heroImg.width) / 2, can.height - heroImg.height); //汽车的显示位置  ：居中

        if ("start" != localStorage.getItem("startGame")) {
            return;
        }

        localStorage.setItem("startGame", "end");
    }

    //清屏并绘制缓存
    function drawBuffer(fontCtx, fontCvs, backCtx, backCvs) {
        fontCtx.clearRect(0, 0, fontCvs.width, fontCvs.height);
        fontCtx.drawImage(backCvs, 0, 0);
    }
    var score = localStorage.getItem("score");

    $('.ipt').click(function() {
        $('.round-car').addClass('fadeInleftBig');
    });

    function pageInitGame() {
        if (localStorage == null) {
            alert("您的浏览器不支持该游戏");
            return;
        }
        localStorage.setItem("startGame", "start");
        // $("#page2").hide();
        // $("#page3").show();
        App.gameStart("canvas", 6);
    }
    localStorage.setItem("score", 0);


})

//游戏时间