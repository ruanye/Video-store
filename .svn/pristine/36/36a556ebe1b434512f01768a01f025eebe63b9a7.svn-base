//url请求参数
var REQUEST = (function GetRequest() {
	var url = location.search;
	var theRequest = new Object();
	if (url.indexOf("?") != -1) {
		var str = url.substr(1);
		strs = str.split("&");
		for(var i = 0; i < strs.length; i ++) {
			theRequest[strs[i].split("=")[0]]=(strs[i].split("=")[1]);
		}
	}
	return theRequest;
})();
Config = {
  hostUrl:""
}
if( REQUEST.page ){
  togglePage(REQUEST.page);
}
if( REQUEST.mask ){
  toggleMask(REQUEST.mask);
}
function togglePage( pageIndex ){
  $(".page").removeClass("active");
	$(".mask").removeClass("active");
  $(".page"+pageIndex).addClass("active");
}

function toggleMask( maskIndex ){
  $(".mask").removeClass("active");
  $(".mask"+maskIndex).addClass("active");
}

$(function(){

  (function page1(){
    $(".page1 .start span").on("click",function(){
      $(this).html("<div>领取中...</div>");
      $.post(Config.hostUrl + '/promo-ex/grab/'+REQUEST.phaseId,{
        phone:REQUEST.phone,
        uberId:REQUEST.uuid || REQUEST.phone
      },function(data){
				console.log(data);
        if( data.errorCode != 0){
					// $(".mask1 .info").css({
					// 	fontSize:'.4rem'
					// }).html(data.message);
					// $(".mask1 .circle").remove();
        	// toggleMask(1);
        }else{
					$(".mask1 .circle").attr({
						src:"images/jiagsaw/"+(data.object.promoExPieceId)+".min.png"
					});
					toggleMask(1);
				}

				setTimeout(function(){
					$.get(Config.hostUrl + '/promo-ex/myPieces/'+REQUEST.promoId,{
						phone:REQUEST.phone,
						uberId:REQUEST.uuid || REQUEST.phone
					},function(data){
						console.log(data);
						var htmlStr = '<img src="images/jiagsaw/bj.png" class="item">';
						(data.list || []).forEach(function(item,index){
							htmlStr += '<img src="images/jiagsaw/'+item.promoExPieceId+'.png" class="item">';
		          $(".page2 .codes .code").eq(item.pieceType-1).attr("src",'images/jiagsaw/'+item.promoExPieceId+'.code.png').addClass('active');
						});
						$(".page2 .items").html(htmlStr);
						togglePage(2);
					});
					//获取下阶段提示
					$.get(Config.hostUrl + '/promo-ex/phases/' + REQUEST.phaseId,{},function( data ){
						if( !data.object.content ){
							$('.page2 .btn.next').off("click").addClass('disable');
						}
						$(".page2 .btn.next .tips").html('<div><p>'+data.object.content+'</p></div>');
					});

				},data.errorCode != 0?0:2000);
      });
    });
  })();

  (function page2() {
    $('.page2 .btn').on('click',function(){
      if( $(this).find('.tips').hasClass('active') ){
				$('.page2 .btn .tips').hide().removeClass('active');
        return false;
      }
      $('.page2 .btn .tips').hide().removeClass('active');
      $(this).find('.tips').show().addClass('active');
      return false;
    });
    $('.page2').on('click',function(){
      $('.page2 .btn .tips').hide().removeClass('active');
    })
  })();

	(function mask1(){
		$(".mask1 .btngo").on('click',function(){
			$.get(Config.hostUrl + '/promo-ex/myPieces/'+REQUEST.promoId,{
				phone:REQUEST.phone,
				uberId:REQUEST.uuid || REQUEST.phone
			},function(data){
				console.log(data);
				var htmlStr = '<img src="images/jiagsaw/bj.png" class="item">';
				(data.list || []).forEach(function(item,index){
					htmlStr += '<img src="images/jiagsaw/'+item.promoExPieceId+'.png" class="item">';
          $(".page2 .codes .code").eq(item.pieceType-1).attr("src",'images/jiagsaw/'+item.promoExPieceId+'.code.png').addClass('active');
				});
				$(".page2 .items").html(htmlStr);
				togglePage(2);
			});
		});
	})();
});
