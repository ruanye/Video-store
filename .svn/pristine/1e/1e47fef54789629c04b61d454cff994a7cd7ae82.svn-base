/**
 * Created by yanghc on 16/5/25.
 */



var SET ={
    init:function(){
        $.init();
        if(LS.get(Constants.isLicense) == 'true'){
           // $.alert('张鹏您好,由于您的爱车是新车,帮小妹需要亲自为您服务,请保持电话畅通哦^-^');
        }
        $('.item-msg').bind('click',function(){
            var item_btn = $(this);
            if(item_btn.hasClass('active')){
                item_btn.removeClass("active");
            }else{
                item_btn.addClass("active");
            }
        });
        $('.more-btn > a').bind('click',function(){
            var more_btn = $(this);
            if($('.more-content').hasClass('hide')){
                $('.more-content').removeClass('hide').addClass('show');
                more_btn.html('收起更多险种<i class="iconfont icon-shouqi"></i>');
            }else{
                $('.more-content').removeClass('show').addClass('hide');
                more_btn.html('更多险种<i class="iconfont icon-shuangjiantou"></i>');
            }
        });
        $('#addCarInfo').bind('click', function(){
             window.location.href = "entry-car.html";
        });
        $('.cst-title').picker({
            toolbarTemplate: '<header class="bar bar-nav">\
                              <button class="button button-link pull-right close-picker">确定</button>\
                              <h1 class="title">套餐类型</h1>\
                              </header>',
            rotateEffect:false,//是否启用3D效果，启用3D可能会影响性能
            onClose:function(){
              selectCheckBox(this.input.value)
            },
            cols: [
                {
                    textAlign: 'center',
                    values: ['经济型', '热门型', '全面型', '自定型']
                }
            ]
        });
        var pickObjs = [];
        for (var i=0;i<3;i++) {
            pickObjs[i] = {
                toolbarTemplate: '<header class="bar bar-nav">\
                      <button class="button button-link pull-right close-picker">确定</button>\
                      <h1 class="title">套餐金额</h1>\
                      </header>',
                      rotateEffect:false,
                      cols: [
                          {
                              textAlign: 'center',
                              values: []
                          }
                      ]
            };
        }
        pickObjs[0].cols[0].values = ['5万', '10万', '15万', '20万','30万', '50万', '100万'];
        $('.item-price-5w100w').picker(pickObjs[0]);
        pickObjs[1].cols[0].values = ['1万', '2万', '5万', '10万', '20万'];
        $('.item-price-1w20w').picker(pickObjs[1]);
        pickObjs[2].cols[0].values = ['2千', '5千', '1万', '2万'];
        $('.item-price-2k2w').picker(pickObjs[2]);
        $('.item-glass').picker({
            toolbarTemplate: '<header class="bar bar-nav">\
                              <button class="button button-link pull-right close-picker">确定</button>\
                              <h1 class="title">玻璃类型</h1>\
                              </header>',
            rotateEffect:false,
            cols: [
                {
                    textAlign: 'center',
                    values: ['国产玻璃', '进口玻璃']
                }
            ]
        });
        //JS打开侧栏
        $(document).on("click", ".car-num", function() {
            $.openPanel("#panel-car-list");
        });
        $.get(Constants.hostIp+"weixin/trade/listVehicle?user="+localStorage.userId, null, function(data) {
            if(data.status==0&&data.list.length>0){
              var carList = data.list || [];
              var s = '';
              var carIndex = 0;
              for (var i=0;i<carList.length;i++) {
                  var lpn = carList[i].lpn;
                  var vehicleId = carList[i].id;
                  if (lpn && lpn.length == 7) {
                      s += '<li>'+
                              '<div class="item-content">'+
                              '<div class="item-inner">'+
                              '<div class="item-title" onclick="selectVehicle(this, '+vehicleId+')">'+(lpn || "未上牌")+'</div>'+
                              '</div>'+
                              '</div>'+
                              '<div class="edit-content" data-lpn="'+lpn+'" data-id="'+vehicleId+'" data-name="'+data.list[i].ownerName+'">'+
                                  '<img src="images/edit-icon.png" alt="">'+
                              '</div>'+
                            '</li>';
                  }
              }
              $('#car-num').html(carList[carIndex].lpn || "未上牌");
              $('.panel-car-num').html(carList[carIndex].lpn || "未上牌");
              $("#car-list-ul").html(s);
              sessionStorage.lpn = carList[carIndex].lpn;
              sessionStorage.vehicleId = carList[carIndex].id;
              sessionStorage.ownerName = carList[carIndex].ownerName;
              SET.carList = carList;
            }
        });
        //新增轿车信息
        $('#addCarInfo').click(function(){
            $.router.load('entry-car.html', false);
            $.closePanel();//关闭侧栏
        });
        //车牌编辑
        $("#car-list-ul").on('click','.edit-content',function(e){
            var $vehicleId=$(this).data('id')
            var $ownerName=$(this).data('name')
            var $lpn=$(this).data('lpn')
            sessionStorage.vehicleId = $vehicleId;
            sessionStorage.ownerName = $ownerName;
            sessionStorage.lpn = $lpn;
            // $.router.load('car-edit.html', false);
            // $.closePanel();//关闭侧栏
            location.href="carEdit.html"
        })
        for (var i=1;i<=4;i++) {
            selectSuit(i);
        }
    },
    getPriceData:function(){
        var price = [];
        for(var i = 1; i <= 1000; i ++){
            price.push(i + '万');
        }
        return price;
    }
}

SET.init();

//更换轿车信息
function selectVehicle(item, vehicleId) {
    var car_num = $(item).html();
    $('#car-num').html(car_num);
    $('.panel-car-num').html(car_num);
    $.closePanel();//关闭侧栏
    sessionStorage.lpn = car_num;
    sessionStorage.vehicleId = vehicleId;
    for (var i=0;i<SET.carList.length;i++) {
        if (SET.carList[i].id == vehicleId) {
            sessionStorage.ownerName = SET.carList[i].ownerName;
        }
    }
    $.post(Constants.hostIp+"weixin/trade/touchVehicle", {vehicleId: vehicleId}, null);
}

function optionSwithOn(idx) {
    $("#opt-"+idx+" .item-msg").show();
    $("#opt-"+idx+" .opt-extra").show();
    if (optionRawDict[idx].isExtra) {
        $("#opt-"+idx+" .item-msg").addClass("active");
    }
    $("#opt-"+idx).find("input")[0].checked = 1;
}

function optionSwithOff(idx) {
    $("#opt-"+idx+" .item-msg").hide();
    $("#opt-"+idx+" .opt-extra").hide();
    $("#opt-"+idx+" .item-msg").removeClass("active");
    $("#opt-"+idx).find("input")[0].checked = 0;
}

function listIncludes(lista, n) {
    if (!lista || !lista.length) {
        return false;
    }
    for (var i=0;i<lista.length;i++) {
        if (lista[i] === n) {
            return true;
        }
    }
    return false;
}

function checkOption(item ,idx) {
    if (item.checked) {
        optionSwithOn(idx);
        var preIdList = curOptList[idx].preIdList;
        if (preIdList && preIdList[0]) {
            optionSwithOn(preIdList[0]);
        }
        for (var x in curOptList) {
            if (listIncludes(curOptList[x].preIdList, idx)) {
                optionSwithOn(x);
            }
        }
        if (idx == 16) {
            optionSwithOn(15);
        }
    } else {
        optionSwithOff(idx);
        for (var x in curOptList) {
            if (listIncludes(curOptList[x].preIdList, idx)) {
                optionSwithOff(x);
            }
        }
        if (idx == 16) {
            optionSwithOff(15);
        }
    }
    $(".cst-title")[0].value = "自定型";
}

function selectCheckBox(suitName) {
    for (var i=0;i<localOptList.length;i++) {
        if (suitName == localOptList[i].suitName) {
            curOptList = localOptList[i].options;
            break;
        }
    }
    for (var x in curOptList) {
         var item = curOptList[x];
         if ($("#opt-"+x).length == 0) {
             continue;
         }
         $("#opt-"+x).show();
         $("#opt-"+x).find("input")[0].checked = (item.isChecked == 1);
         if (item.isExtra === 1) {
            $("#opt-"+x+" .item-msg").show();
            $("#opt-"+x+" .item-msg").addClass("active");
         }
         if (item.isExtra === 0) {
            $("#opt-"+x+" .item-msg").show();
            $("#opt-"+x+" .item-msg").removeClass("active");
         }
         if (item.extraInfo) {
            $("#opt-"+x+" .opt-extra").show();
            $("#opt-"+x).find("input")[1].value = item.extraInfo;
         }
         if (!item.isChecked) {
            $("#opt-"+x+" .item-msg").hide();
            $("#opt-"+x+" .opt-extra").hide();
         }
    }
    if (curOptList[15].isChecked == 1) {
        optionSwithOn(16);
    } else {
        optionSwithOff(16);
    }
}

function onOptionSubmit() {
    sessionStorage.suitName=$('.cst-title').val();
    var ret = {};
    var lpn = $('#car-num').html() || "未上牌";
    if (lpn == "未上牌") {
        $.alert("新车未上牌请等待人工帮助");
        return;
    }
    $(".content-block a").html("正在查询报价，请稍候……");
    $.showPreloader('正在查询报价……');
    for (var x in curOptList) {
        var item = curOptList[x];
        if ($("#opt-"+x).length == 0) {
            continue;
        }
        ret[x] = {isChecked: 0};
        if ($("#opt-"+x)[0].style.display == 'none') {
             continue;
        }
        ret[x].isChecked = $("#opt-"+x).find("input")[0].checked ? 1 : 0;
        if ($("#opt-"+x+" .item-msg").length) {
            ret[x].isExtra = $("#opt-"+x+" .item-msg").hasClass("active") ? 1 : 0;
        }
        if ($("#opt-"+x+" .opt-extra").length) {
            ret[x].extraInfo = $("#opt-"+x+" .opt-extra")[0].value;
        }
    }
    $.post(Constants.hostIp+"weixin/pricequery", {
        userId:parseInt(localStorage.userId || 1),
        lpn:$('#car-num').html(),
        options:JSON.stringify(ret)
    }, function(data) {
        $.hidePreloader();
        if (data.status != 0) {
            if (data.msg == "查询保费响应超时") {
                $.alert("网络不给力,请稍候重试");
            } else if (data.msg.indexOf("重复投保") != -1) {
                $.alert("查询失败,本车辆发生重复投保");
            } else if (data.msg == "已保存的车型代码无效，请重新检查") {
                $.alert(data.msg, function() {
                    window.location.href = "carEdit.html";
                });
            } else if (data.debugMsg && data.debugMsg.indexOf("JSONArray[0] not found")!=-1) {
                $.alert("已保存的车型代码无效，请重新检查", function() {
                    window.location.href = "carEdit.html";
                });
            } else if (data.debugMsg === null) {
                $.alert("查询报价失败");
            } else {
                $.alert("查询报价失败");
            }
            $(".content-block a").html("再次查询报价");
            return;
        }
        $(".content-block a").html("查询报价");
        optObj = JSON.parse(data.optionJson);
        var sumpremium = parseFloat(optObj.commercial) || 0;
        var sumpaytax = parseFloat(optObj.tax) || 0;
        var bzprice = parseFloat(optObj.compulsory) || 0;
        sessionStorage.commercialInsurance = parseInt(sumpremium*100);
        sessionStorage.compulsoryInsurance = parseInt(bzprice*100);
        sessionStorage.insuranceCompanyId = 4;
        sessionStorage.tax = parseInt(sumpaytax*100);
        sessionStorage.optionJson = data.optionJson;
        sessionStorage.optionSession = data.optionSession;
        window.location.href = 'pre-price.html';
    });
}

var optionTemp = [
    [1, 15], //车辆损失险
    [8, 19], //全车盗抢险
    [9, 20], //车身划痕损失险
    [0, 6, 7], //玻璃单独破碎险(国产，进口)
    [13, 23], //自燃损失险
    [12, 22], //发加动机涉水损失险
    [3], //修理期间费用补偿险
    [10], //指定修理厂险
    [14], //机动车损失保险无
    [11, 21], //新增设备损失险
    [2, 16], //第三者责任险
    [4, 17], //司机座位险
    [5, 18], //乘客座位险
    [],
    [24], //交强险
    []
];

function selectSuit(n) {
    function isInSuit(options, optId) {
        for (var i=0;i<options.length;i++) {
            if (options[i].id == optId) {
                return options[i].isSelected;
            }
        }
        return 0;
    }
    $.get(Constants.hostIp+"weixin/insuranceSuit/detail?id="+n, null, function(data) {
        var options = data.options;
        for (var i=1;i<=16;i++) {
            var opt = optionTemp[i-1];
            var target = localOptList[n-1].options[i];
            if (opt.length == 1) {
                target.isChecked = isInSuit(options, opt[0]);
            } else if (opt.length == 2) {
                target.isChecked = isInSuit(options, opt[0]) || isInSuit(options, opt[1]);
                target.isExtra = isInSuit(options, opt[1]);
            } else if (opt.length == 3) {
                target.isChecked = isInSuit(options, opt[1]) || isInSuit(options, opt[2]);
                target.extraInfo = isInSuit(options, opt[2]) ? "进口玻璃" : "国产玻璃";
            } else {
                target.isChecked = 0;
            }
        }
        selectCheckBox();
    });
}

var optionRawDict = {
    1: {isExtra:1},  //车辆损失险
    2: {isExtra:1, preId:1},  //全车盗抢险
    3: {isExtra:1, extraInfo:'1万', preId:1},  //车身划痕损失险
    4: {extraInfo:'国产玻璃', preId:1},  //玻璃单独破碎险(国产，进口)
    5: {isExtra:1, preId:1},  //自燃损失险
    6: {preId:1},  //发加动机涉水损失险
    7: {preId:1},  //修理期间费用补偿险
    8: {},  //指定修理厂险
    9: {preId:1},  //机动车损失保险无
    10: {},  //新增设备损失险
    11: {isExtra:1, extraInfo:'5万'},  //第三者责任险
    12: {isExtra:1, extraInfo:'2万', preId:11},  //司机座位险
    13: {isExtra:1, extraInfo:'1万', preId:11},  //乘客座位险
    14: {},  //精神损失险
    15: {},  //交强险
    16: {preId:15},  //车船税
};

var suitNameList = ['经济型', '热门型', '全面型', '自定型'];

var localOptList = [];
suitNameList.forEach(function(name, idx) {
    localOptList[idx] = {suitName: name, options: {}};
    for (k in optionRawDict) {
        var v = optionRawDict[k];
        var obj = {isChecked: 0};
        if (v.isExtra) {
            obj.isExtra = 1;
        }
        if (v.extraInfo) {
            obj.extraInfo = v.extraInfo;
        }
        obj.preIdList = v.preId ? [v.preId] : [];
        localOptList[idx].options[k] = obj;
    }
});

var suitIndex = window.location.href.match(/suit=\d+/);
if (suitIndex && suitIndex.length != 0 ){
    suitIndex = suitIndex[0].split("=")[1];
}
suitIndex = parseInt(suitIndex) || 0;
$(".cst-title")[0].value = localOptList[suitIndex].suitName;
var curOptList = localOptList[suitIndex].options;

